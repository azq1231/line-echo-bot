import{r as d,c as B,o as te,p as se,b as o,d as n,e,f as j,t as i,F as N,i as A,n as D,k as I,v as le,q as ae,j as v,s as oe,m as ne}from"./runtime-dom.esm-bundler-wIgYT9iR.js";import{_ as ie}from"./_plugin-vue_export-helper-Bg17vRIm.js";async function de(){const r=await fetch("/api/admin/users",{credentials:"include"});if(!r.ok)throw new Error("Fetch failed");return await r.json()}async function re(r,a,m){const p=await fetch("/api/admin/update_user_field",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:r,field:a,value:m}),credentials:"include"});if(!p.ok)throw new Error("Update failed");return p.json()}async function ce(r){const a=await fetch("/api/admin/users/add_manual",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:r}),credentials:"include"});if(!a.ok)throw new Error("Add failed");return a.json()}async function ue(r,a){const m=await fetch("/api/admin/users/merge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_user_id:r,target_user_id:a}),credentials:"include"});if(!m.ok)throw new Error("Merge failed");return m.json()}async function me(r){const a=await fetch(`/api/admin/users/${r}`,{method:"DELETE",credentials:"include"});if(!a.ok)throw new Error("Delete failed");return a.json()}async function pe(r,a){const m=await fetch(`/api/admin/users/${r}/update_reminder_schedule`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedule_type:a}),credentials:"include"});if(!m.ok)throw new Error("Update failed");return m.json()}async function be(r){const a=await fetch(`/api/admin/users/${r}/appointments`,{credentials:"include"});if(!a.ok)throw new Error("Fetch appointments failed");return a.json()}const ve={class:"user-management-page container py-3"},fe={class:"d-flex justify-content-end align-items-center mb-3"},ye={class:"d-flex gap-2 align-items-center"},he=["value"],ge={class:"mb-3 text-primary fw-bold"},we={key:0,class:"d-flex justify-content-center align-items-center",style:{"min-height":"300px"}},_e={key:1,class:"alert alert-danger"},ke={key:2,class:"table-responsive"},xe={class:"table table-striped table-bordered mb-0 align-middle"},Me={class:"text-center"},Ce=["src"],Ue={class:"user-details"},$e={class:"d-flex align-items-center"},Se=["onClick"],Ee=["onClick"],Te={key:0,class:"mt-1"},je=["onClick"],ze={class:"d-flex gap-2 align-items-center mt-2"},Le=["onClick"],Ne=["onClick"],Ae={class:"mt-2"},De=["value","onChange"],Fe={class:"text-center"},Oe={class:"d-flex flex-column gap-1"},Re=["onClick"],Ve=["onClick"],Be=["onClick"],Ie={key:3,class:"position-fixed top-0 end-0 p-3",style:{"z-index":"1100"}},Je={class:"d-flex"},Pe={class:"toast-body"},He={class:"modal-dialog modal-dialog-centered"},Ke={class:"modal-content"},We={class:"modal-body"},Ze={class:"modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"},qe={class:"modal-content"},Ge={class:"modal-header"},Qe={class:"modal-title",id:"historyModalLabel"},Xe={class:"modal-body"},Ye={key:0,class:"text-center py-4"},et={key:1,class:"alert alert-danger"},tt={key:2},st={class:"mb-3 p-2 bg-light rounded"},lt={class:"text-primary"},at={class:"text-muted"},ot={key:0,class:"text-center text-muted py-4"},nt={key:1,class:"table table-sm table-hover"},it={class:"badge bg-secondary"},dt={class:"modal-dialog modal-dialog-centered"},rt={class:"modal-content"},ct={class:"modal-body"},ut=["value"],mt={class:"modal-footer"},pt=["disabled"],bt={__name:"UserManagement",setup(r){const a=d([]),m=d(!0),p=d(null),M=d(""),F=d(!1),C=d(new Set),h=d(null),f=d(null),g=d(null);let b=null;const U=d(""),z=d(null);let w=null;const y=d({show:!1,message:"",type:"info"}),_=d(null);let k=null;const O=d(null),$=d([]),x=d({total:0,future:0,past:0}),L=d(!1),S=d(null),R=B(()=>{if(!M.value)return a.value;const s=M.value.toLowerCase();return a.value.filter(t=>t.name.toLowerCase().includes(s)||t.zhuyin&&t.zhuyin.toLowerCase().includes(s))}),J=B(()=>a.value.filter(s=>s.id&&!s.id.startsWith("manual_")));function u(s,t="success",l=3e3){y.value={show:!0,message:s,type:t},setTimeout(()=>{y.value.show=!1},l)}const P=s=>{s.target.src="/static/nohead.png"},E=async()=>{m.value=!0,p.value=null;try{const s=await de();a.value=s.users,F.value=s.allow_user_deletion}catch(s){p.value="ç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",console.error(s)}finally{m.value=!1}},H=s=>{C.value.has(s)?C.value.delete(s):C.value.add(s)},K=s=>({name:"å§“å",zhuyin:"æ³¨éŸ³",phone:"é›»è©±(å¸‚)",phone2:"é›»è©±(æ‰‹)"})[s]||"æ¬„ä½",T=async(s,t)=>{const l=s[t]||"",c=prompt(`è«‹è¼¸å…¥ ${s.name} çš„æ–°${K(t)}ï¼š`,l);if(c!==null&&c.trim()!==l){const ee=c.trim();try{await re(s.id,t,ee),u("âœ… æ›´æ–°æˆåŠŸ","success"),await E()}catch{u("âŒ æ›´æ–°å¤±æ•—","error")}}};te(async()=>{await se(),await E();const s=()=>{window.bootstrap?(g.value&&(b=new window.bootstrap.Modal(g.value),console.log("âœ… Merge Modal åˆå§‹åŒ–æˆåŠŸ")),z.value&&(w=new window.bootstrap.Modal(z.value),console.log("âœ… Add Manual Modal åˆå§‹åŒ–æˆåŠŸ")),_.value&&(k=new window.bootstrap.Modal(_.value),console.log("âœ… History Modal åˆå§‹åŒ–æˆåŠŸ"))):(console.warn("â³ ç­‰å¾… Bootstrap è¼‰å…¥ä¸­..."),setTimeout(s,200))};s()});const W=s=>{h.value=s,f.value="",!b&&window.bootstrap&&g.value&&(b=new window.bootstrap.Modal(g.value),console.log("âš™ï¸ å³æ™‚åˆå§‹åŒ– Modal")),b?(b.show(),console.log("ğŸ“¦ é–‹å•Ÿåˆä½µç”¨æˆ¶è¦–çª—")):(console.error("âŒ ç„¡æ³•é–‹å•Ÿ Modalï¼šBootstrap æœªè¼‰å…¥æˆ– ref å°šæœªç¶å®š"),alert("ç³»çµ±å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚"))},Z=()=>{U.value="",w?w.show():(console.error("âŒ ç„¡æ³•é–‹å•Ÿæ–°å¢ç”¨æˆ¶ Modal"),alert("ç³»çµ±å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚"))},V=async()=>{const s=U.value.trim();if(!s){u("âŒ è«‹è¼¸å…¥ç”¨æˆ¶å§“å","error");return}try{const t=await ce(s);a.value.unshift(t.user),u("âœ… è‡¨æ™‚ç”¨æˆ¶å·²æ–°å¢","success"),w&&w.hide()}catch(t){u(`âŒ æ–°å¢å¤±æ•—: ${t.message||"æœªçŸ¥éŒ¯èª¤"}`,"error")}},q=async()=>{if(!h.value||!f.value){u("âŒ è«‹é¸æ“‡ç›®æ¨™ç”¨æˆ¶","error");return}if(confirm(`ç¢ºå®šè¦å°‡ ${h.value.name} çš„æ‰€æœ‰è³‡æ–™åˆä½µåˆ°ç›®æ¨™ç”¨æˆ¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`))try{await ue(h.value.id,f.value),u("âœ… åˆä½µæˆåŠŸ","success"),b&&b.hide(),await E()}catch(s){u(`âŒ åˆä½µå¤±æ•—: ${s.message||"æœªçŸ¥éŒ¯èª¤"}`,"error")}},G=async s=>{if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç”¨æˆ¶å—ï¼Ÿæ‰€æœ‰ç›¸é—œçš„é ç´„ç´€éŒ„ä¹Ÿå°‡è¢«åˆªé™¤ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚"))try{await me(s),u("âœ… ç”¨æˆ¶å·²åˆªé™¤","success"),await E()}catch(t){u(`âŒ åˆªé™¤å¤±æ•—: ${t.message||"æœªçŸ¥éŒ¯èª¤"}`,"error")}},Q=async(s,t)=>{const l=t.target.value;try{await pe(s.id,l),s.reminder_schedule=l,u("âœ… æé†’è¨­å®šå·²æ›´æ–°","success")}catch(c){u(`âŒ æ›´æ–°å¤±æ•—: ${c.message||"æœªçŸ¥éŒ¯èª¤"}`,"error"),t.target.value=s.reminder_schedule}},X=async s=>{O.value=s,$.value=[],x.value={total:0,future:0,past:0},L.value=!0,S.value=null,!k&&window.bootstrap&&_.value&&(k=new window.bootstrap.Modal(_.value)),k&&k.show();try{const t=await be(s.id);if(t.status==="success")$.value=t.appointments,x.value=t.stats;else throw new Error(t.message||"ç²å–é ç´„ç´€éŒ„å¤±æ•—")}catch(t){S.value=`ç„¡æ³•è¼‰å…¥é ç´„ç´€éŒ„: ${t.message||"æœªçŸ¥éŒ¯èª¤"}`,console.error("Failed to load user appointments:",t)}finally{L.value=!1}},Y=s=>{const t=new Date;return new Date(`${s.date} ${s.time}`)>t&&s.status==="confirmed"};return(s,t)=>(n(),o("div",ve,[t[29]||(t[29]=e("div",{class:"p-3 mb-4 rounded",style:{"background-color":"#e9ecef"}},[e("p",{class:"mb-1"},[e("strong",null,"ğŸ’¡ æç¤ºï¼š")]),e("ul",{class:"mb-1 ps-4",style:{"font-size":"0.9rem"}},[e("li",null,"ç”¨æˆ¶åŠ å¥½å‹æˆ–ç™¼è¨Šæ¯æ™‚æœƒè‡ªå‹•åŠ å…¥æ¸…å–®ã€‚"),e("li",null,"é»æ“Šç”¨æˆ¶å§“åæˆ–é›»è©±è™Ÿç¢¼å¯ä»¥æ‰‹å‹•ä¿®æ”¹ã€‚âœï¸")])],-1)),e("div",fe,[e("div",ye,[e("input",{type:"text",class:"form-control",placeholder:"ä¾å§“åæˆ–æ³¨éŸ³æœå°‹...",value:M.value,onInput:t[0]||(t[0]=l=>M.value=l.target.value),style:{width:"200px"}},null,40,he),e("button",{class:"btn btn-primary",onClick:Z},"æ–°å¢è‡¨æ™‚ç”¨æˆ¶")])]),e("h2",ge,"ğŸ“‹ ç”¨æˆ¶æ¸…å–® ("+i(R.value.length)+")",1),m.value?(n(),o("div",we,[...t[4]||(t[4]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"è¼‰å…¥ä¸­...")],-1)])])):p.value?(n(),o("div",_e,i(p.value),1)):(n(),o("div",ke,[e("table",xe,[t[13]||(t[13]=e("thead",{class:"table-light"},[e("tr",null,[e("th",{scope:"col",style:{width:"40px"},class:"text-center"},"é ­åƒ"),e("th",{scope:"col"},"ç”¨æˆ¶è³‡è¨Š"),e("th",{scope:"col",class:"text-center",style:{width:"50px"}},"æ“ä½œ")])],-1)),e("tbody",null,[(n(!0),o(N,null,A(R.value,l=>(n(),o("tr",{key:l.id},[e("td",Me,[e("img",{src:`/users/user_avatar/${l.id}`,alt:"avatar",class:"rounded-circle",style:{width:"40px",height:"40px","object-fit":"cover"},onError:P},null,40,Ce)]),e("td",Ue,[e("div",$e,[e("span",{onClick:c=>T(l,"name"),class:"editable-field fw-bold fs-6"},[v(i(l.name)+" ",1),t[5]||(t[5]=e("i",{class:"bi bi-pencil-fill text-primary ms-1"},null,-1))],8,Se),e("button",{onClick:c=>H(l.id),class:"btn btn-sm btn-link py-0 px-1 text-secondary",title:"é¡¯ç¤º/éš±è—æ³¨éŸ³"},"[æ³¨]",8,Ee)]),C.value.has(l.id)?(n(),o("div",Te,[e("span",{onClick:c=>T(l,"zhuyin"),class:"editable-field text-secondary",style:{"font-size":"0.8rem"}},i(l.zhuyin||"[é»æ“Šæ–°å¢]"),9,je)])):j("",!0),e("div",ze,[e("span",{onClick:c=>T(l,"phone"),class:"editable-field text-muted small flex-shrink-0"},[t[6]||(t[6]=e("i",{class:"bi bi-telephone-fill me-1"},null,-1)),v(i(l.phone||"å¸‚è©±"),1)],8,Le),e("span",{onClick:c=>T(l,"phone2"),class:"editable-field text-muted small flex-shrink-0"},[t[7]||(t[7]=e("i",{class:"bi bi-phone-fill me-1"},null,-1)),v(i(l.phone2||"æ‰‹æ©Ÿ"),1)],8,Ne)]),e("div",Ae,[t[9]||(t[9]=e("label",{class:"form-label-sm me-2"},"æé†’è¨­å®šï¼š",-1)),e("select",{class:"form-select-sm",value:l.reminder_schedule,onChange:c=>Q(l,c)},[...t[8]||(t[8]=[e("option",{value:"weekly"},"æ¯é€±æé†’",-1),e("option",{value:"daily"},"æ¯æ—¥æé†’ (å‰ä¸€å¤©)",-1)])],40,De)])]),e("td",Fe,[e("div",Oe,[e("button",{onClick:c=>X(l),class:"btn btn-sm btn-outline-primary px-2 icon-btn",title:"æŸ¥çœ‹æ­·å²ç´€éŒ„"},[...t[10]||(t[10]=[e("i",{class:"bi bi-calendar-check",style:{"font-size":"1.1rem"}},null,-1)])],8,Re),l.id.startsWith("manual_")?(n(),o("button",{key:0,onClick:c=>W(l),class:"btn btn-sm btn-outline-success px-2 icon-btn",title:"åˆä½µç”¨æˆ¶"},[...t[11]||(t[11]=[e("i",{class:"bi bi-person-plus-fill",style:{"font-size":"1.1rem"}},null,-1)])],8,Ve)):j("",!0),F.value?(n(),o("button",{key:1,onClick:c=>G(l.id),class:"btn btn-sm btn-outline-danger px-2 icon-btn",title:"åˆªé™¤ç”¨æˆ¶"},[...t[12]||(t[12]=[e("i",{class:"bi bi-trash-fill",style:{"font-size":"1.1rem"}},null,-1)])],8,Be)):j("",!0)])])]))),128))])])])),y.value.show?(n(),o("div",Ie,[e("div",{class:D(`toast show align-items-center text-white border-0 ${y.value.type==="success"?"bg-success":"bg-danger"}`),role:"alert","aria-live":"assertive","aria-atomic":"true"},[e("div",Je,[e("div",Pe,i(y.value.message),1),e("button",{type:"button",class:"btn-close btn-close-white me-2 m-auto",onClick:t[1]||(t[1]=l=>y.value.show=!1),"aria-label":"Close"})])],2)])):j("",!0),e("div",{class:"modal fade",id:"addManualUserModal",tabindex:"-1","aria-labelledby":"addManualUserModalLabel","aria-hidden":"true",ref_key:"addManualModalRef",ref:z},[e("div",He,[e("div",Ke,[t[17]||(t[17]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"addManualUserModalLabel"},"æ–°å¢è‡¨æ™‚ç”¨æˆ¶"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),e("div",We,[t[14]||(t[14]=e("label",{for:"manualUserName",class:"form-label"},"ç”¨æˆ¶å§“å",-1)),I(e("input",{type:"text",class:"form-control",id:"manualUserName","onUpdate:modelValue":t[2]||(t[2]=l=>U.value=l),placeholder:"ä¾‹å¦‚ï¼šé™³å…ˆç”Ÿ-æ‰‹æ©Ÿæœ«å››ç¢¼",onKeyup:ae(V,["enter"])},null,544),[[le,U.value]]),t[15]||(t[15]=e("div",{class:"form-text"},"ç‚ºç„¡æ³•ä½¿ç”¨ LINE ç™»å…¥çš„ç”¨æˆ¶ï¼ˆå¦‚é›»è©±é ç´„å®¢ï¼‰å»ºç«‹ä¸€å€‹è‡¨æ™‚å¸³è™Ÿã€‚",-1))]),e("div",{class:"modal-footer"},[t[16]||(t[16]=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"å–æ¶ˆ",-1)),e("button",{type:"button",class:"btn btn-primary",onClick:V},"å„²å­˜")])])])],512),e("div",{class:"modal fade",id:"historyModal",tabindex:"-1","aria-labelledby":"historyModalLabel","aria-hidden":"true",ref_key:"historyModalRef",ref:_},[e("div",Ze,[e("div",qe,[e("div",Ge,[e("h5",Qe,"ğŸ“… "+i(O.value?.name)+" çš„é ç´„æ­·å²",1),t[18]||(t[18]=e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"},null,-1))]),e("div",Xe,[L.value?(n(),o("div",Ye,[...t[19]||(t[19]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"è¼‰å…¥ä¸­...")],-1)])])):S.value?(n(),o("div",et,i(S.value),1)):(n(),o("div",tt,[e("div",st,[t[20]||(t[20]=e("strong",null,"çµ±è¨ˆï¼š",-1)),v(" ç¸½è¨ˆ "+i(x.value.total)+" æ¬¡é ç´„ | ",1),e("span",lt,"å°šæœ‰ "+i(x.value.future)+" æ¬¡",1),t[21]||(t[21]=v(" | ",-1)),e("span",at,"éå» "+i(x.value.past)+" æ¬¡",1)]),$.value.length===0?(n(),o("div",ot," æ­¤ç”¨æˆ¶å°šç„¡é ç´„ç´€éŒ„ ")):(n(),o("table",nt,[t[22]||(t[22]=e("thead",null,[e("tr",null,[e("th",null,"æ—¥æœŸ"),e("th",null,"æ™‚é–“"),e("th",null,"é¡å‹"),e("th",null,"ç‹€æ…‹")])],-1)),e("tbody",null,[(n(!0),o(N,null,A($.value,l=>(n(),o("tr",{key:l.id,class:D({"table-primary":Y(l)})},[e("td",null,i(l.date),1),e("td",null,i(l.time),1),e("td",null,[e("span",{class:D(["badge",l.type==="massage"?"bg-success":"bg-info"])},i(l.type==="massage"?"æ¨æ‹¿":"çœ‹è¨º"),3)]),e("td",null,[e("span",it,i(l.status==="confirmed"?"å·²ç¢ºèª":l.status),1)])],2))),128))])]))]))]),t[23]||(t[23]=e("div",{class:"modal-footer"},[e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"é—œé–‰")],-1))])])],512),e("div",{class:"modal fade",id:"mergeUserModal",tabindex:"-1","aria-labelledby":"mergeUserModalLabel","aria-hidden":"true",ref_key:"mergeModalRef",ref:g},[e("div",dt,[e("div",rt,[t[28]||(t[28]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"mergeUserModalLabel"},"åˆä½µç”¨æˆ¶"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),e("div",ct,[e("p",null,[t[24]||(t[24]=v("å°‡è‡¨æ™‚ç”¨æˆ¶ ",-1)),e("strong",null,i(h.value?.name),1),t[25]||(t[25]=v(" çš„æ‰€æœ‰é ç´„ç´€éŒ„åˆä½µè‡³ä»¥ä¸‹çœŸå¯¦ç”¨æˆ¶ï¼š",-1))]),I(e("select",{class:"form-select","onUpdate:modelValue":t[3]||(t[3]=l=>f.value=l)},[t[26]||(t[26]=e("option",{disabled:"",value:""},"è«‹é¸æ“‡ä¸€å€‹ç›®æ¨™ç”¨æˆ¶...",-1)),(n(!0),o(N,null,A(J.value,l=>(n(),o("option",{key:l.id,value:l.id},i(l.name)+" ("+i(l.id)+")",9,ut))),128))],512),[[oe,f.value]])]),e("div",mt,[t[27]||(t[27]=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"å–æ¶ˆ",-1)),e("button",{type:"button",class:"btn btn-danger",onClick:q,disabled:!f.value},"ç¢ºèªåˆä½µ",8,pt)])])])],512)]))}},vt=ie(bt,[["__scopeId","data-v-17b6d6df"]]);async function ft(){ne(vt).mount("#app")}ft();
