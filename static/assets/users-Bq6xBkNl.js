import{r as i,c as E,o as P,k as K,b as r,d,e,f as $,t as p,F as N,h as S,n as W,l as L,v as Z,m as q,i as k,p as G,j as H}from"./runtime-dom.esm-bundler-DJNFZJ1Y.js";async function Q(){const l=await fetch("/api/admin/users",{credentials:"include"});if(!l.ok)throw new Error("Fetch failed");return await l.json()}async function X(l,n,o){const b={name:"/admin/update_user_name",zhuyin:"/admin/update_user_zhuyin",phone:"/admin/update_user_phone",phone2:"/admin/update_user_phone"}[n],c={user_id:l};n==="phone"||n==="phone2"?(c.phone=o,c.field=n):c[n]=o;const h=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),credentials:"include"});if(!h.ok)throw new Error("Update failed");return h.json()}async function Y(l){const n=await fetch("/api/admin/users/add_manual",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:l}),credentials:"include"});if(!n.ok)throw new Error("Add failed");return n.json()}async function ee(l,n){const o=await fetch("/api/admin/users/merge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_user_id:l,target_user_id:n}),credentials:"include"});if(!o.ok)throw new Error("Merge failed");return o.json()}async function te(l){const n=await fetch(`/api/admin/users/${l}`,{method:"DELETE",credentials:"include"});if(!n.ok)throw new Error("Delete failed");return n.json()}const se=(l,n)=>{const o=l.__vccOpts||l;for(const[b,c]of n)o[b]=c;return o},ae={class:"user-management-page container py-3"},ne={class:"d-flex justify-content-end align-items-center mb-3"},le={class:"d-flex gap-2 align-items-center"},oe=["value"],ie={class:"mb-3 text-primary fw-bold"},re={key:0,class:"d-flex justify-content-center align-items-center",style:{"min-height":"300px"}},de={key:1,class:"alert alert-danger"},ce={key:2,class:"table-responsive"},ue={class:"table table-striped table-bordered mb-0 align-middle"},me={class:"text-center"},pe=["src"],be={class:"user-details"},ve={class:"d-flex align-items-center"},fe=["onClick"],ye=["onClick"],he={key:0,class:"mt-1"},ge=["onClick"],we={class:"d-flex gap-2 align-items-center mt-2"},_e=["onClick"],ke=["onClick"],xe={class:"text-center"},Me={class:"d-flex flex-column gap-1"},Ce=["onClick"],Ue=["onClick"],$e={key:3,class:"position-fixed top-0 end-0 p-3",style:{"z-index":"1100"}},ze={class:"d-flex"},Te={class:"toast-body"},je={class:"modal-dialog modal-dialog-centered"},Ee={class:"modal-content"},Ne={class:"modal-body"},Se={class:"modal-dialog modal-dialog-centered"},Le={class:"modal-content"},Ae={class:"modal-body"},Oe=["value"],Ve={class:"modal-footer"},Be=["disabled"],De={__name:"UserManagement",setup(l){const n=i([]),o=i(!0),b=i(null),c=i(""),h=i(!1),x=i(new Set),g=i(null),f=i(null),w=i(null);let v=null;const M=i(""),z=i(null);let _=null;const y=i({show:!1,message:"",type:"info"}),T=E(()=>{if(!c.value)return n.value;const s=c.value.toLowerCase();return n.value.filter(t=>t.name.toLowerCase().includes(s)||t.zhuyin&&t.zhuyin.toLowerCase().includes(s))}),A=E(()=>n.value.filter(s=>s.id&&!s.id.startsWith("manual_")));function u(s,t="success",a=3e3){y.value={show:!0,message:s,type:t},setTimeout(()=>{y.value.show=!1},a)}const O=s=>{s.target.src="/static/nohead.png"},C=async()=>{o.value=!0,b.value=null;try{const s=await Q();n.value=s.users,h.value=s.allow_user_deletion}catch(s){b.value="無法載入用戶資料，請稍後再試。",console.error(s)}finally{o.value=!1}},V=s=>{x.value.has(s)?x.value.delete(s):x.value.add(s)},B=s=>({name:"姓名",zhuyin:"注音",phone:"電話(市)",phone2:"電話(手)"})[s]||"欄位",U=async(s,t)=>{const a=s[t]||"",m=prompt(`請輸入 ${s.name} 的新${B(t)}：`,a);if(m!==null&&m.trim()!==a){const J=m.trim();try{await X(s.id,t,J),u("✅ 更新成功","success"),await C()}catch{u("❌ 更新失敗","error")}}};P(async()=>{await K(),await C();const s=()=>{window.bootstrap?(w.value&&(v=new window.bootstrap.Modal(w.value),console.log("✅ Merge Modal 初始化成功")),z.value&&(_=new window.bootstrap.Modal(z.value),console.log("✅ Add Manual Modal 初始化成功"))):(console.warn("⏳ 等待 Bootstrap 載入中..."),setTimeout(s,200))};s()});const D=s=>{g.value=s,f.value="",!v&&window.bootstrap&&w.value&&(v=new window.bootstrap.Modal(w.value),console.log("⚙️ 即時初始化 Modal")),v?(v.show(),console.log("📦 開啟合併用戶視窗")):(console.error("❌ 無法開啟 Modal：Bootstrap 未載入或 ref 尚未綁定"),alert("系統尚未載入完成，請稍後再試一次。"))},F=()=>{M.value="",_?_.show():(console.error("❌ 無法開啟新增用戶 Modal"),alert("系統尚未載入完成，請稍後再試一次。"))},j=async()=>{const s=M.value.trim();if(!s){u("❌ 請輸入用戶姓名","error");return}try{const t=await Y(s);n.value.unshift(t.user),u("✅ 臨時用戶已新增","success"),_&&_.hide()}catch(t){u(`❌ 新增失敗: ${t.message||"未知錯誤"}`,"error")}},I=async()=>{if(!g.value||!f.value){u("❌ 請選擇目標用戶","error");return}if(confirm(`確定要將 ${g.value.name} 的所有資料合併到目標用戶嗎？此操作無法復原。`))try{await ee(g.value.id,f.value),u("✅ 合併成功","success"),v&&v.hide(),await C()}catch(s){u(`❌ 合併失敗: ${s.message||"未知錯誤"}`,"error")}},R=async s=>{if(confirm("確定要刪除此用戶嗎？所有相關的預約紀錄也將被刪除，此操作無法復原。"))try{await te(s),u("✅ 用戶已刪除","success"),await C()}catch(t){u(`❌ 刪除失敗: ${t.message||"未知錯誤"}`,"error")}};return(s,t)=>(d(),r("div",ae,[t[20]||(t[20]=e("div",{class:"p-3 mb-4 rounded",style:{"background-color":"#e9ecef"}},[e("p",{class:"mb-1"},[e("strong",null,"💡 提示：")]),e("ul",{class:"mb-1 ps-4",style:{"font-size":"0.9rem"}},[e("li",null,"用戶加好友或發訊息時會自動加入清單。"),e("li",null,"點擊用戶姓名或電話號碼可以手動修改。✏️")])],-1)),e("div",ne,[e("div",le,[e("input",{type:"text",class:"form-control",placeholder:"依姓名或注音搜尋...",value:c.value,onInput:t[0]||(t[0]=a=>c.value=a.target.value),style:{width:"200px"}},null,40,oe),e("button",{class:"btn btn-primary",onClick:F},"新增臨時用戶")])]),e("h2",ie,"📋 用戶清單 ("+p(T.value.length)+")",1),o.value?(d(),r("div",re,[...t[4]||(t[4]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"載入中...")],-1)])])):b.value?(d(),r("div",de,p(b.value),1)):(d(),r("div",ce,[e("table",ue,[t[10]||(t[10]=e("thead",{class:"table-light"},[e("tr",null,[e("th",{scope:"col",style:{width:"40px"},class:"text-center"},"頭像"),e("th",{scope:"col"},"用戶資訊"),e("th",{scope:"col",class:"text-center",style:{width:"50px"}},"操作")])],-1)),e("tbody",null,[(d(!0),r(N,null,S(T.value,a=>(d(),r("tr",{key:a.id},[e("td",me,[e("img",{src:`/user_avatar/${a.id}`,alt:"avatar",class:"rounded-circle",style:{width:"40px",height:"40px","object-fit":"cover"},onError:O},null,40,pe)]),e("td",be,[e("div",ve,[e("span",{onClick:m=>U(a,"name"),class:"editable-field fw-bold fs-6"},[k(p(a.name)+" ",1),t[5]||(t[5]=e("i",{class:"bi bi-pencil-fill text-primary ms-1"},null,-1))],8,fe),e("button",{onClick:m=>V(a.id),class:"btn btn-sm btn-link py-0 px-1 text-secondary",title:"顯示/隱藏注音"},"[注]",8,ye)]),x.value.has(a.id)?(d(),r("div",he,[e("span",{onClick:m=>U(a,"zhuyin"),class:"editable-field text-secondary",style:{"font-size":"0.8rem"}},p(a.zhuyin||"[點擊新增]"),9,ge)])):$("",!0),e("div",we,[e("span",{onClick:m=>U(a,"phone"),class:"editable-field text-muted small flex-shrink-0"},[t[6]||(t[6]=e("i",{class:"bi bi-telephone-fill me-1"},null,-1)),k(p(a.phone||"市話"),1)],8,_e),e("span",{onClick:m=>U(a,"phone2"),class:"editable-field text-muted small flex-shrink-0"},[t[7]||(t[7]=e("i",{class:"bi bi-phone-fill me-1"},null,-1)),k(p(a.phone2||"手機"),1)],8,ke)])]),e("td",xe,[e("div",Me,[a.id.startsWith("manual_")?(d(),r("button",{key:0,onClick:m=>D(a),class:"btn btn-sm btn-outline-success px-2 icon-btn",title:"合併用戶"},[...t[8]||(t[8]=[e("i",{class:"bi bi-person-plus-fill",style:{"font-size":"1.1rem"}},null,-1)])],8,Ce)):$("",!0),h.value?(d(),r("button",{key:1,onClick:m=>R(a.id),class:"btn btn-sm btn-outline-danger px-2 icon-btn",title:"刪除用戶"},[...t[9]||(t[9]=[e("i",{class:"bi bi-trash-fill",style:{"font-size":"1.1rem"}},null,-1)])],8,Ue)):$("",!0)])])]))),128))])])])),y.value.show?(d(),r("div",$e,[e("div",{class:W(`toast show align-items-center text-white border-0 ${y.value.type==="success"?"bg-success":"bg-danger"}`),role:"alert","aria-live":"assertive","aria-atomic":"true"},[e("div",ze,[e("div",Te,p(y.value.message),1),e("button",{type:"button",class:"btn-close btn-close-white me-2 m-auto",onClick:t[1]||(t[1]=a=>y.value.show=!1),"aria-label":"Close"})])],2)])):$("",!0),e("div",{class:"modal fade",id:"addManualUserModal",tabindex:"-1","aria-labelledby":"addManualUserModalLabel","aria-hidden":"true",ref_key:"addManualModalRef",ref:z},[e("div",je,[e("div",Ee,[t[14]||(t[14]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"addManualUserModalLabel"},"新增臨時用戶"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),e("div",Ne,[t[11]||(t[11]=e("label",{for:"manualUserName",class:"form-label"},"用戶姓名",-1)),L(e("input",{type:"text",class:"form-control",id:"manualUserName","onUpdate:modelValue":t[2]||(t[2]=a=>M.value=a),placeholder:"例如：陳先生-手機末四碼",onKeyup:q(j,["enter"])},null,544),[[Z,M.value]]),t[12]||(t[12]=e("div",{class:"form-text"},"為無法使用 LINE 登入的用戶（如電話預約客）建立一個臨時帳號。",-1))]),e("div",{class:"modal-footer"},[t[13]||(t[13]=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"取消",-1)),e("button",{type:"button",class:"btn btn-primary",onClick:j},"儲存")])])])],512),e("div",{class:"modal fade",id:"mergeUserModal",tabindex:"-1","aria-labelledby":"mergeUserModalLabel","aria-hidden":"true",ref_key:"mergeModalRef",ref:w},[e("div",Se,[e("div",Le,[t[19]||(t[19]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"mergeUserModalLabel"},"合併用戶"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),e("div",Ae,[e("p",null,[t[15]||(t[15]=k("將臨時用戶 ",-1)),e("strong",null,p(g.value?.name),1),t[16]||(t[16]=k(" 的所有預約紀錄合併至以下真實用戶：",-1))]),L(e("select",{class:"form-select","onUpdate:modelValue":t[3]||(t[3]=a=>f.value=a)},[t[17]||(t[17]=e("option",{disabled:"",value:""},"請選擇一個目標用戶...",-1)),(d(!0),r(N,null,S(A.value,a=>(d(),r("option",{key:a.id,value:a.id},p(a.name)+" ("+p(a.id)+")",9,Oe))),128))],512),[[G,f.value]])]),e("div",Ve,[t[18]||(t[18]=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"取消",-1)),e("button",{type:"button",class:"btn btn-danger",onClick:I,disabled:!f.value},"確認合併",8,Be)])])])],512)]))}},Fe=se(De,[["__scopeId","data-v-a78bcb72"]]);async function Ie(){H(Fe).mount("#app")}Ie();
