import{r,c as E,o as K,m as W,b as d,d as c,e,f as U,t as m,F as z,i as N,n as Z,p as L,v as q,q as G,j as w,s as H,l as Q}from"./runtime-dom.esm-bundler-DLYAdE7D.js";import{_ as X}from"./_plugin-vue_export-helper-Bg17vRIm.js";async function Y(){const o=await fetch("/api/admin/users",{credentials:"include"});if(!o.ok)throw new Error("Fetch failed");return await o.json()}async function ee(o,l,u){const p=await fetch("/api/admin/update_user_field",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:o,field:l,value:u}),credentials:"include"});if(!p.ok)throw new Error("Update failed");return p.json()}async function te(o){const l=await fetch("/api/admin/users/add_manual",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o}),credentials:"include"});if(!l.ok)throw new Error("Add failed");return l.json()}async function se(o,l){const u=await fetch("/api/admin/users/merge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_user_id:o,target_user_id:l}),credentials:"include"});if(!u.ok)throw new Error("Merge failed");return u.json()}async function ae(o){const l=await fetch(`/api/admin/users/${o}`,{method:"DELETE",credentials:"include"});if(!l.ok)throw new Error("Delete failed");return l.json()}async function le(o,l){const u=await fetch(`/api/admin/users/${o}/update_reminder_schedule`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedule_type:l}),credentials:"include"});if(!u.ok)throw new Error("Update failed");return u.json()}const ne={class:"user-management-page container py-3"},oe={class:"d-flex justify-content-end align-items-center mb-3"},ie={class:"d-flex gap-2 align-items-center"},re=["value"],de={class:"mb-3 text-primary fw-bold"},ce={key:0,class:"d-flex justify-content-center align-items-center",style:{"min-height":"300px"}},ue={key:1,class:"alert alert-danger"},me={key:2,class:"table-responsive"},pe={class:"table table-striped table-bordered mb-0 align-middle"},fe={class:"text-center"},ve=["src"],be={class:"user-details"},ye={class:"d-flex align-items-center"},he=["onClick"],ge=["onClick"],we={key:0,class:"mt-1"},_e=["onClick"],ke={class:"d-flex gap-2 align-items-center mt-2"},xe=["onClick"],Me=["onClick"],Ce={class:"mt-2"},Ue=["value","onChange"],$e={class:"text-center"},Se={class:"d-flex flex-column gap-1"},Te=["onClick"],je=["onClick"],Ee={key:3,class:"position-fixed top-0 end-0 p-3",style:{"z-index":"1100"}},ze={class:"d-flex"},Ne={class:"toast-body"},Le={class:"modal-dialog modal-dialog-centered"},Ae={class:"modal-content"},Oe={class:"modal-body"},Ve={class:"modal-dialog modal-dialog-centered"},Re={class:"modal-content"},Be={class:"modal-body"},De=["value"],Fe={class:"modal-footer"},Ie=["disabled"],Je={__name:"UserManagement",setup(o){const l=r([]),u=r(!0),p=r(null),_=r(""),S=r(!1),k=r(new Set),y=r(null),v=r(null),h=r(null);let f=null;const x=r(""),$=r(null);let g=null;const b=r({show:!1,message:"",type:"info"}),T=E(()=>{if(!_.value)return l.value;const s=_.value.toLowerCase();return l.value.filter(t=>t.name.toLowerCase().includes(s)||t.zhuyin&&t.zhuyin.toLowerCase().includes(s))}),A=E(()=>l.value.filter(s=>s.id&&!s.id.startsWith("manual_")));function i(s,t="success",a=3e3){b.value={show:!0,message:s,type:t},setTimeout(()=>{b.value.show=!1},a)}const O=s=>{s.target.src="/static/nohead.png"},M=async()=>{u.value=!0,p.value=null;try{const s=await Y();l.value=s.users,S.value=s.allow_user_deletion}catch(s){p.value="ç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",console.error(s)}finally{u.value=!1}},V=s=>{k.value.has(s)?k.value.delete(s):k.value.add(s)},R=s=>({name:"å§“å",zhuyin:"æ³¨éŸ³",phone:"é›»è©±(å¸‚)",phone2:"é›»è©±(æ‰‹)"})[s]||"æ¬„ä½",C=async(s,t)=>{const a=s[t]||"",n=prompt(`è«‹è¼¸å…¥ ${s.name} çš„æ–°${R(t)}ï¼š`,a);if(n!==null&&n.trim()!==a){const P=n.trim();try{await ee(s.id,t,P),i("âœ… æ›´æ–°æˆåŠŸ","success"),await M()}catch{i("âŒ æ›´æ–°å¤±æ•—","error")}}};K(async()=>{await W(),await M();const s=()=>{window.bootstrap?(h.value&&(f=new window.bootstrap.Modal(h.value),console.log("âœ… Merge Modal åˆå§‹åŒ–æˆåŠŸ")),$.value&&(g=new window.bootstrap.Modal($.value),console.log("âœ… Add Manual Modal åˆå§‹åŒ–æˆåŠŸ"))):(console.warn("â³ ç­‰å¾… Bootstrap è¼‰å…¥ä¸­..."),setTimeout(s,200))};s()});const B=s=>{y.value=s,v.value="",!f&&window.bootstrap&&h.value&&(f=new window.bootstrap.Modal(h.value),console.log("âš™ï¸ å³æ™‚åˆå§‹åŒ– Modal")),f?(f.show(),console.log("ğŸ“¦ é–‹å•Ÿåˆä½µç”¨æˆ¶è¦–çª—")):(console.error("âŒ ç„¡æ³•é–‹å•Ÿ Modalï¼šBootstrap æœªè¼‰å…¥æˆ– ref å°šæœªç¶å®š"),alert("ç³»çµ±å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚"))},D=()=>{x.value="",g?g.show():(console.error("âŒ ç„¡æ³•é–‹å•Ÿæ–°å¢ç”¨æˆ¶ Modal"),alert("ç³»çµ±å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚"))},j=async()=>{const s=x.value.trim();if(!s){i("âŒ è«‹è¼¸å…¥ç”¨æˆ¶å§“å","error");return}try{const t=await te(s);l.value.unshift(t.user),i("âœ… è‡¨æ™‚ç”¨æˆ¶å·²æ–°å¢","success"),g&&g.hide()}catch(t){i(`âŒ æ–°å¢å¤±æ•—: ${t.message||"æœªçŸ¥éŒ¯èª¤"}`,"error")}},F=async()=>{if(!y.value||!v.value){i("âŒ è«‹é¸æ“‡ç›®æ¨™ç”¨æˆ¶","error");return}if(confirm(`ç¢ºå®šè¦å°‡ ${y.value.name} çš„æ‰€æœ‰è³‡æ–™åˆä½µåˆ°ç›®æ¨™ç”¨æˆ¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`))try{await se(y.value.id,v.value),i("âœ… åˆä½µæˆåŠŸ","success"),f&&f.hide(),await M()}catch(s){i(`âŒ åˆä½µå¤±æ•—: ${s.message||"æœªçŸ¥éŒ¯èª¤"}`,"error")}},I=async s=>{if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç”¨æˆ¶å—ï¼Ÿæ‰€æœ‰ç›¸é—œçš„é ç´„ç´€éŒ„ä¹Ÿå°‡è¢«åˆªé™¤ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚"))try{await ae(s),i("âœ… ç”¨æˆ¶å·²åˆªé™¤","success"),await M()}catch(t){i(`âŒ åˆªé™¤å¤±æ•—: ${t.message||"æœªçŸ¥éŒ¯èª¤"}`,"error")}},J=async(s,t)=>{const a=t.target.value;try{await le(s.id,a),s.reminder_schedule=a,i("âœ… æé†’è¨­å®šå·²æ›´æ–°","success")}catch(n){i(`âŒ æ›´æ–°å¤±æ•—: ${n.message||"æœªçŸ¥éŒ¯èª¤"}`,"error"),t.target.value=s.reminder_schedule}};return(s,t)=>(c(),d("div",ne,[t[22]||(t[22]=e("div",{class:"p-3 mb-4 rounded",style:{"background-color":"#e9ecef"}},[e("p",{class:"mb-1"},[e("strong",null,"ğŸ’¡ æç¤ºï¼š")]),e("ul",{class:"mb-1 ps-4",style:{"font-size":"0.9rem"}},[e("li",null,"ç”¨æˆ¶åŠ å¥½å‹æˆ–ç™¼è¨Šæ¯æ™‚æœƒè‡ªå‹•åŠ å…¥æ¸…å–®ã€‚"),e("li",null,"é»æ“Šç”¨æˆ¶å§“åæˆ–é›»è©±è™Ÿç¢¼å¯ä»¥æ‰‹å‹•ä¿®æ”¹ã€‚âœï¸")])],-1)),e("div",oe,[e("div",ie,[e("input",{type:"text",class:"form-control",placeholder:"ä¾å§“åæˆ–æ³¨éŸ³æœå°‹...",value:_.value,onInput:t[0]||(t[0]=a=>_.value=a.target.value),style:{width:"200px"}},null,40,re),e("button",{class:"btn btn-primary",onClick:D},"æ–°å¢è‡¨æ™‚ç”¨æˆ¶")])]),e("h2",de,"ğŸ“‹ ç”¨æˆ¶æ¸…å–® ("+m(T.value.length)+")",1),u.value?(c(),d("div",ce,[...t[4]||(t[4]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"è¼‰å…¥ä¸­...")],-1)])])):p.value?(c(),d("div",ue,m(p.value),1)):(c(),d("div",me,[e("table",pe,[t[12]||(t[12]=e("thead",{class:"table-light"},[e("tr",null,[e("th",{scope:"col",style:{width:"40px"},class:"text-center"},"é ­åƒ"),e("th",{scope:"col"},"ç”¨æˆ¶è³‡è¨Š"),e("th",{scope:"col",class:"text-center",style:{width:"50px"}},"æ“ä½œ")])],-1)),e("tbody",null,[(c(!0),d(z,null,N(T.value,a=>(c(),d("tr",{key:a.id},[e("td",fe,[e("img",{src:`/users/user_avatar/${a.id}`,alt:"avatar",class:"rounded-circle",style:{width:"40px",height:"40px","object-fit":"cover"},onError:O},null,40,ve)]),e("td",be,[e("div",ye,[e("span",{onClick:n=>C(a,"name"),class:"editable-field fw-bold fs-6"},[w(m(a.name)+" ",1),t[5]||(t[5]=e("i",{class:"bi bi-pencil-fill text-primary ms-1"},null,-1))],8,he),e("button",{onClick:n=>V(a.id),class:"btn btn-sm btn-link py-0 px-1 text-secondary",title:"é¡¯ç¤º/éš±è—æ³¨éŸ³"},"[æ³¨]",8,ge)]),k.value.has(a.id)?(c(),d("div",we,[e("span",{onClick:n=>C(a,"zhuyin"),class:"editable-field text-secondary",style:{"font-size":"0.8rem"}},m(a.zhuyin||"[é»æ“Šæ–°å¢]"),9,_e)])):U("",!0),e("div",ke,[e("span",{onClick:n=>C(a,"phone"),class:"editable-field text-muted small flex-shrink-0"},[t[6]||(t[6]=e("i",{class:"bi bi-telephone-fill me-1"},null,-1)),w(m(a.phone||"å¸‚è©±"),1)],8,xe),e("span",{onClick:n=>C(a,"phone2"),class:"editable-field text-muted small flex-shrink-0"},[t[7]||(t[7]=e("i",{class:"bi bi-phone-fill me-1"},null,-1)),w(m(a.phone2||"æ‰‹æ©Ÿ"),1)],8,Me)]),e("div",Ce,[t[9]||(t[9]=e("label",{class:"form-label-sm me-2"},"æé†’è¨­å®šï¼š",-1)),e("select",{class:"form-select-sm",value:a.reminder_schedule,onChange:n=>J(a,n)},[...t[8]||(t[8]=[e("option",{value:"weekly"},"æ¯é€±æé†’",-1),e("option",{value:"daily"},"æ¯æ—¥æé†’ (å‰ä¸€å¤©)",-1)])],40,Ue)])]),e("td",$e,[e("div",Se,[a.id.startsWith("manual_")?(c(),d("button",{key:0,onClick:n=>B(a),class:"btn btn-sm btn-outline-success px-2 icon-btn",title:"åˆä½µç”¨æˆ¶"},[...t[10]||(t[10]=[e("i",{class:"bi bi-person-plus-fill",style:{"font-size":"1.1rem"}},null,-1)])],8,Te)):U("",!0),S.value?(c(),d("button",{key:1,onClick:n=>I(a.id),class:"btn btn-sm btn-outline-danger px-2 icon-btn",title:"åˆªé™¤ç”¨æˆ¶"},[...t[11]||(t[11]=[e("i",{class:"bi bi-trash-fill",style:{"font-size":"1.1rem"}},null,-1)])],8,je)):U("",!0)])])]))),128))])])])),b.value.show?(c(),d("div",Ee,[e("div",{class:Z(`toast show align-items-center text-white border-0 ${b.value.type==="success"?"bg-success":"bg-danger"}`),role:"alert","aria-live":"assertive","aria-atomic":"true"},[e("div",ze,[e("div",Ne,m(b.value.message),1),e("button",{type:"button",class:"btn-close btn-close-white me-2 m-auto",onClick:t[1]||(t[1]=a=>b.value.show=!1),"aria-label":"Close"})])],2)])):U("",!0),e("div",{class:"modal fade",id:"addManualUserModal",tabindex:"-1","aria-labelledby":"addManualUserModalLabel","aria-hidden":"true",ref_key:"addManualModalRef",ref:$},[e("div",Le,[e("div",Ae,[t[16]||(t[16]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"addManualUserModalLabel"},"æ–°å¢è‡¨æ™‚ç”¨æˆ¶"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),e("div",Oe,[t[13]||(t[13]=e("label",{for:"manualUserName",class:"form-label"},"ç”¨æˆ¶å§“å",-1)),L(e("input",{type:"text",class:"form-control",id:"manualUserName","onUpdate:modelValue":t[2]||(t[2]=a=>x.value=a),placeholder:"ä¾‹å¦‚ï¼šé™³å…ˆç”Ÿ-æ‰‹æ©Ÿæœ«å››ç¢¼",onKeyup:G(j,["enter"])},null,544),[[q,x.value]]),t[14]||(t[14]=e("div",{class:"form-text"},"ç‚ºç„¡æ³•ä½¿ç”¨ LINE ç™»å…¥çš„ç”¨æˆ¶ï¼ˆå¦‚é›»è©±é ç´„å®¢ï¼‰å»ºç«‹ä¸€å€‹è‡¨æ™‚å¸³è™Ÿã€‚",-1))]),e("div",{class:"modal-footer"},[t[15]||(t[15]=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"å–æ¶ˆ",-1)),e("button",{type:"button",class:"btn btn-primary",onClick:j},"å„²å­˜")])])])],512),e("div",{class:"modal fade",id:"mergeUserModal",tabindex:"-1","aria-labelledby":"mergeUserModalLabel","aria-hidden":"true",ref_key:"mergeModalRef",ref:h},[e("div",Ve,[e("div",Re,[t[21]||(t[21]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"mergeUserModalLabel"},"åˆä½µç”¨æˆ¶"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),e("div",Be,[e("p",null,[t[17]||(t[17]=w("å°‡è‡¨æ™‚ç”¨æˆ¶ ",-1)),e("strong",null,m(y.value?.name),1),t[18]||(t[18]=w(" çš„æ‰€æœ‰é ç´„ç´€éŒ„åˆä½µè‡³ä»¥ä¸‹çœŸå¯¦ç”¨æˆ¶ï¼š",-1))]),L(e("select",{class:"form-select","onUpdate:modelValue":t[3]||(t[3]=a=>v.value=a)},[t[19]||(t[19]=e("option",{disabled:"",value:""},"è«‹é¸æ“‡ä¸€å€‹ç›®æ¨™ç”¨æˆ¶...",-1)),(c(!0),d(z,null,N(A.value,a=>(c(),d("option",{key:a.id,value:a.id},m(a.name)+" ("+m(a.id)+")",9,De))),128))],512),[[H,v.value]])]),e("div",Fe,[t[20]||(t[20]=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"å–æ¶ˆ",-1)),e("button",{type:"button",class:"btn btn-danger",onClick:F,disabled:!v.value},"ç¢ºèªåˆä½µ",8,Ie)])])])],512)]))}},Pe=X(Je,[["__scopeId","data-v-6a1a3671"]]);async function Ke(){Q(Pe).mount("#app")}Ke();
