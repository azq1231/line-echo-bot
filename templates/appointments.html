{% extends "base.html" %}

{% block title %}é ç´„ç®¡ç†{% endblock %}

{% block header %}ğŸ“… é ç´„ç®¡ç†{% endblock %}

{% block content %}


<div class="page-header">
    <div class="header-buttons">
        <button class="btn btn-primary" onclick="changeWeek(-1)">â¬…ï¸ ä¸Šä¸€é€±</button>
        <button class="btn btn-primary" onclick="changeWeek(1)">ä¸‹ä¸€é€± â¡ï¸</button>
        <button class="btn btn-primary" onclick="loadInitialData()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        <button class="btn btn-success" onclick="sendWeekReminders(event)">ğŸ“¨ ç™¼é€æ•´é€±æé†’</button>
    </div>
</div>
<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
    <h2 id="weekTitle" style="color: var(--primary-color); font-size: 20px; margin: 0;"></h2>
</div>
<div id="schedule" class="schedule-grid"></div>

<div id="statusMessage" class="status-message"></div>

<script>
    let allUsers = [];
    let groupedUsers = {};
    let weekSchedule = {};
    let currentWeekOffset = 0;
    let openSelect = null;

    document.addEventListener('click', function(e) {
        if (openSelect && !openSelect.contains(e.target)) {
            closeAllSelects();
        }
    });

    function closeAllSelects() {
        document.querySelectorAll('.custom-select-options.show').forEach(el => el.classList.remove('show'));
        openSelect = null;
    }

    async function loadInitialData() {
        showStatus('è¼‰å…¥ä¸­...', 'info');
        await loadUsers();
        await loadSchedule();
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();
            allUsers = data.users || [];
            groupedUsers = groupUsersByZhuyin(allUsers);
        } catch (error) {
            showStatus('âŒ ç”¨æˆ¶è¼‰å…¥å¤±æ•—', 'error');
        }
    }

    function groupUsersByZhuyin(users) {
        const groups = users.reduce((acc, user) => {
            const initial = user.zhuyin ? user.zhuyin[0] : '#';
            if (!acc[initial]) acc[initial] = [];
            acc[initial].push(user);
            return acc;
        }, {});
        return groups;
    }

    async function loadSchedule() {
        try {
            const response = await fetch(`/api/admin/get_week_appointments?offset=${currentWeekOffset}`);
            const data = await response.json();
            console.log("Received schedule data:", data); // ç”¨æ–¼èª¿è©¦
            weekSchedule = data.week_schedule || {};
            updateWeekTitle();
            renderSchedule();
            showStatus('âœ… è³‡æ–™å·²æ›´æ–°', 'success');
        } catch (error) {
            showStatus('âŒ æ’ç¨‹è¼‰å…¥å¤±æ•—', 'error');
        }
    }

    function updateWeekTitle() {
        const titleEl = document.getElementById('weekTitle');
        if (currentWeekOffset === 0) titleEl.textContent = 'æœ¬é€±é ç´„';
        else if (currentWeekOffset === 1) titleEl.textContent = 'ä¸‹é€±é ç´„';
        else if (currentWeekOffset === -1) titleEl.textContent = 'ä¸Šé€±é ç´„';
        else if (currentWeekOffset > 1) titleEl.textContent = `æœªä¾†ç¬¬ ${currentWeekOffset} é€±`;
        else titleEl.textContent = `éå»ç¬¬ ${Math.abs(currentWeekOffset)} é€±`;
    }

    function changeWeek(offset) {
        currentWeekOffset += offset;
        loadSchedule();
    }

    function renderSchedule() {
        const scheduleDiv = document.getElementById('schedule');
        scheduleDiv.innerHTML = '';
        const days = Object.values(weekSchedule);
        if (days.length === 0) {
            scheduleDiv.innerHTML = '<p>ç„¡é ç´„è³‡æ–™</p>';
            return;
        }

        for (const dayData of days) {
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            const { date_info, appointments } = dayData;

            let timeSlotsHtml;
            if (dayData.is_closed) {
                timeSlotsHtml = `<div class="closed-day-overlay">ğŸ˜´<br>æœ¬æ—¥ä¼‘è¨º</div>`;
            } else {
                timeSlotsHtml = Object.entries(appointments).map(([time, apt]) => {
                    const user = allUsers.find(u => u.id === apt.user_id);
                    return `
                        <div class="time-slot">
                            <span class="time-label">${time}</span>
                            <div class="custom-select-container">
                                ${generateCustomSelect(date_info.date, time, user)}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            dayCard.innerHTML = `
                <div class="day-header"><h3>${date_info.day_name}</h3><p>${date_info.display}</p></div>
                <div class="time-slots">${timeSlotsHtml}</div>
                ${!dayData.is_closed ? `<button class="send-day-btn" onclick="sendDayReminders(event, '${date_info.date}', '${date_info.day_name}')">ğŸ“¤ ç™¼é€ ${date_info.day_name} æé†’</button>` : ''}
            `;
            scheduleDiv.appendChild(dayCard);
        }
    }

    function generateCustomSelect(date, time, user) {
        const displayText = user ? user.name : '-- æœªé ç´„ --';
        const displayClass = user ? '' : 'empty';
        const userId = user ? user.user_id : '';
        return `
            <div class="custom-select-display ${displayClass}"
                 data-date="${date}" data-time="${time}" data-user-id="${userId}"
                 onclick="toggleDropdown(this)">
                ${displayText}
            </div>
            <div class="custom-select-options"></div>
        `;
    }

    function toggleDropdown(displayElement) {
        const optionsPanel = displayElement.nextElementSibling;
        const wasOpen = optionsPanel.classList.contains('show');
        closeAllSelects();
        if (!wasOpen) {
            optionsPanel.classList.add('show');
            openSelect = displayElement.parentElement;
            renderZhuyinOptions(displayElement);
        }
    }

    function renderZhuyinOptions(displayElement) {
        const optionsPanel = displayElement.nextElementSibling;
        const zhuyinOrder = 'ã„…ã„†ã„‡ã„ˆã„‰ã„Šã„‹ã„Œã„ã„ã„ã„ã„‘ã„’ã„“ã„”ã„•ã„–ã„—ã„˜ã„™ã„§ã„¨ã„©ã„šã„›ã„œã„ã„ã„Ÿã„ ã„¡ã„¢ã„£ã„¤ã„¥ã„¦#';
        const sortedKeys = Object.keys(groupedUsers).sort((a, b) => {
            if (a === '#') return 1;
            if (b === '#') return -1;
            return zhuyinOrder.indexOf(a) - zhuyinOrder.indexOf(b);
        });

        let optionsHtml = `<div class="custom-option" onclick="event.stopPropagation(); selectUser(this, '', '-- æœªé ç´„ --')">-- æœªé ç´„ --</div>`;
        optionsHtml += sortedKeys.map(key =>
            `<div class="custom-option" onclick="event.stopPropagation(); renderUserOptions(this, '${key}')">${key}</div>`
        ).join('');
        optionsPanel.innerHTML = optionsHtml;
    }

    function renderUserOptions(optionElement, zhuyinInitial) {
        const displayElement = optionElement.closest('.custom-select-container').querySelector('.custom-select-display');
        const optionsPanel = displayElement.nextElementSibling;
        const usersInGroup = groupedUsers[zhuyinInitial] || [];

        let userOptionsHtml = `<div class="custom-option back-option" onclick="event.stopPropagation(); renderZhuyinOptions(this.closest('.custom-select-container').querySelector('.custom-select-display'))">â† è¿”å›æ³¨éŸ³</div>`;
        userOptionsHtml += usersInGroup.map(user =>
            `<div class="custom-option" onclick="event.stopPropagation(); selectUser(this, '${user.user_id}', '${user.name}')">${user.name}</div>`
        ).join('');

        optionsPanel.innerHTML = userOptionsHtml;
    }

    function selectUser(optionElement, userId, userName) {
        const displayElement = optionElement.closest('.custom-select-container').querySelector('.custom-select-display');
        displayElement.textContent = userName;
        displayElement.classList.remove('empty');
        displayElement.dataset.userId = userId;

        const { date, time } = displayElement.dataset;
        if (userId) {
            saveAppointment(date, time, userId, userName);
        } else {
            // å¦‚æœ userId ç‚ºç©ºï¼Œè¡¨ç¤ºè¦å–æ¶ˆé ç´„
            cancelAppointment(date, time);
        }
        closeAllSelects();
    }

    async function saveAppointment(date, time, userId, userName) {
        showStatus('å„²å­˜ä¸­...', 'info');
        try {
            const response = await fetch('/api/admin/save_appointment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, time, user_id: userId, user_name: userName })
            });
            if (response.ok) {
                showStatus('âœ… é ç´„å·²å„²å­˜', 'success');
            } else { showStatus('âŒ å„²å­˜å¤±æ•—', 'error'); }
        } catch (error) { showStatus('âŒ å„²å­˜å¤±æ•—', 'error'); }
    }

    async function cancelAppointment(date, time) {
        // å¾Œç«¯ save_appointment å‚³ç©ºå€¼å³å¯å–æ¶ˆï¼Œå‰ç«¯å¯é¸æ“‡æ€§å¯¦ä½œå°ˆé–€çš„å–æ¶ˆ API
        // é€™è£¡æˆ‘å€‘ç¹¼çºŒä½¿ç”¨ save_appointment çš„é‚è¼¯
        await saveAppointment(date, time, '', '');
    }

    async function sendWeekReminders(event) {
        if (!confirm('ç¢ºå®šè¦ç™¼é€æ•´é€±çš„é ç´„æé†’å—ï¼Ÿ')) return;
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'ç™¼é€ä¸­...';
        try {
            const response = await fetch('/api/admin/send_appointment_reminders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'week' })
            });
            const result = await response.json();
            showStatus(`âœ… å·²ç™¼é€ ${result.sent_count} å‰‡æé†’${result.failed_count > 0 ? `ï¼Œ${result.failed_count} å‰‡å¤±æ•—` : ''}`);
        } catch (error) {
            showStatus('âŒ ç™¼é€å¤±æ•—', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ“¨ ç™¼é€æ•´é€±æé†’';
        }
    }

    async function sendDayReminders(event, date, dayName) {
        if (!confirm(`ç¢ºå®šè¦ç™¼é€ ${dayName} çš„é ç´„æé†’å—ï¼Ÿ`)) return;
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'ç™¼é€ä¸­...';
        try {
            const response = await fetch('/api/admin/send_appointment_reminders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'day', date: date })
            });
            const result = await response.json();
            showStatus(`âœ… å·²ç™¼é€ ${dayName} çš„ ${result.sent_count} å‰‡æé†’${result.failed_count > 0 ? `ï¼Œ${result.failed_count} å‰‡å¤±æ•—` : ''}`);
        } catch (error) {
            showStatus('âŒ ç™¼é€å¤±æ•—', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = `ğŸ“¤ ç™¼é€ ${dayName} æé†’`;
        }
    }

    function showStatus(message, type = 'success') {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = `status-message ${type} show`;
        setTimeout(() => { statusDiv.className = 'status-message'; }, 3000);
    }

    loadInitialData();
</script>
{% endblock %}
