{% extends "base.html" %}

{% block title %}預約管理{% endblock %}

{% block header %}📅 預約管理{% endblock %}

{% block content %}


<div class="page-header">
    <div class="header-buttons">
        <button class="btn btn-primary" onclick="changeWeek(-1)">⬅️ 上一週</button>
        <button class="btn btn-primary" onclick="changeWeek(1)">下一週 ➡️</button>
        <button class="btn btn-primary" onclick="loadInitialData()">🔄 重新載入</button>
        <button class="btn btn-success" onclick="sendWeekReminders(event)">📨 發送整週提醒</button>
    </div>
</div>
<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
    <h2 id="weekTitle" style="color: var(--primary-color); font-size: 20px; margin: 0;"></h2>
</div>
<div id="schedule" class="schedule-grid"></div>

<div id="statusMessage" class="status-message"></div>

<script>
    let allUsers = [];
    let groupedUsers = {};
    let weekSchedule = {};
    let currentWeekOffset = 0;
    let openSelect = null;

    document.addEventListener('click', function(e) {
        if (openSelect && !openSelect.contains(e.target)) {
            closeAllSelects();
        }
    });

    function closeAllSelects() {
        document.querySelectorAll('.custom-select-options.show').forEach(el => el.classList.remove('show'));
        openSelect = null;
    }

    async function loadInitialData() {
        showStatus('載入中...', 'info');
        await loadUsers();
        await loadSchedule();
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();
            allUsers = data.users || [];
            groupedUsers = groupUsersByZhuyin(allUsers);
        } catch (error) {
            showStatus('❌ 用戶載入失敗', 'error');
        }
    }

    function groupUsersByZhuyin(users) {
        const groups = users.reduce((acc, user) => {
            const initial = user.zhuyin ? user.zhuyin[0] : '#';
            if (!acc[initial]) acc[initial] = [];
            acc[initial].push(user);
            return acc;
        }, {});
        return groups;
    }

    async function loadSchedule() {
        try {
            const response = await fetch(`/api/admin/get_week_appointments?offset=${currentWeekOffset}`);
            const data = await response.json();
            console.log("Received schedule data:", data); // 用於調試
            weekSchedule = data.week_schedule || {};
            updateWeekTitle();
            renderSchedule();
            showStatus('✅ 資料已更新', 'success');
        } catch (error) {
            showStatus('❌ 排程載入失敗', 'error');
        }
    }

    function updateWeekTitle() {
        const titleEl = document.getElementById('weekTitle');
        if (currentWeekOffset === 0) titleEl.textContent = '本週預約';
        else if (currentWeekOffset === 1) titleEl.textContent = '下週預約';
        else if (currentWeekOffset === -1) titleEl.textContent = '上週預約';
        else if (currentWeekOffset > 1) titleEl.textContent = `未來第 ${currentWeekOffset} 週`;
        else titleEl.textContent = `過去第 ${Math.abs(currentWeekOffset)} 週`;
    }

    function changeWeek(offset) {
        currentWeekOffset += offset;
        loadSchedule();
    }

    function renderSchedule() {
        const scheduleDiv = document.getElementById('schedule');
        scheduleDiv.innerHTML = '';
        const days = Object.values(weekSchedule);
        if (days.length === 0) {
            scheduleDiv.innerHTML = '<p>無預約資料</p>';
            return;
        }

        for (const dayData of days) {
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            const { date_info, appointments } = dayData;

            let timeSlotsHtml;
            if (dayData.is_closed) {
                timeSlotsHtml = `<div class="closed-day-overlay">😴<br>本日休診</div>`;
            } else {
                timeSlotsHtml = Object.entries(appointments).map(([time, apt]) => {
                    const user = allUsers.find(u => u.id === apt.user_id);
                    return `
                        <div class="time-slot">
                            <span class="time-label">${time}</span>
                            <div class="custom-select-container">
                                ${generateCustomSelect(date_info.date, time, user)}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            dayCard.innerHTML = `
                <div class="day-header"><h3>${date_info.day_name}</h3><p>${date_info.display}</p></div>
                <div class="time-slots">${timeSlotsHtml}</div>
                ${!dayData.is_closed ? `<button class="send-day-btn" onclick="sendDayReminders(event, '${date_info.date}', '${date_info.day_name}')">📤 發送 ${date_info.day_name} 提醒</button>` : ''}
            `;
            scheduleDiv.appendChild(dayCard);
        }
    }

    function generateCustomSelect(date, time, user) {
        const displayText = user ? user.name : '-- 未預約 --';
        const displayClass = user ? '' : 'empty';
        const userId = user ? user.user_id : '';
        return `
            <div class="custom-select-display ${displayClass}"
                 data-date="${date}" data-time="${time}" data-user-id="${userId}"
                 onclick="toggleDropdown(this)">
                ${displayText}
            </div>
            <div class="custom-select-options"></div>
        `;
    }

    function toggleDropdown(displayElement) {
        const optionsPanel = displayElement.nextElementSibling;
        const wasOpen = optionsPanel.classList.contains('show');
        closeAllSelects();
        if (!wasOpen) {
            optionsPanel.classList.add('show');
            openSelect = displayElement.parentElement;
            renderZhuyinOptions(displayElement);
        }
    }

    function renderZhuyinOptions(displayElement) {
        const optionsPanel = displayElement.nextElementSibling;
        const zhuyinOrder = 'ㄅㄆㄇㄈㄉㄊㄋㄌㄍㄎㄏㄐㄑㄒㄓㄔㄕㄖㄗㄘㄙㄧㄨㄩㄚㄛㄜㄝㄞㄟㄠㄡㄢㄣㄤㄥㄦ#';
        const sortedKeys = Object.keys(groupedUsers).sort((a, b) => {
            if (a === '#') return 1;
            if (b === '#') return -1;
            return zhuyinOrder.indexOf(a) - zhuyinOrder.indexOf(b);
        });

        let optionsHtml = `<div class="custom-option" onclick="event.stopPropagation(); selectUser(this, '', '-- 未預約 --')">-- 未預約 --</div>`;
        optionsHtml += sortedKeys.map(key =>
            `<div class="custom-option" onclick="event.stopPropagation(); renderUserOptions(this, '${key}')">${key}</div>`
        ).join('');
        optionsPanel.innerHTML = optionsHtml;
    }

    function renderUserOptions(optionElement, zhuyinInitial) {
        const displayElement = optionElement.closest('.custom-select-container').querySelector('.custom-select-display');
        const optionsPanel = displayElement.nextElementSibling;
        const usersInGroup = groupedUsers[zhuyinInitial] || [];

        let userOptionsHtml = `<div class="custom-option back-option" onclick="event.stopPropagation(); renderZhuyinOptions(this.closest('.custom-select-container').querySelector('.custom-select-display'))">← 返回注音</div>`;
        userOptionsHtml += usersInGroup.map(user =>
            `<div class="custom-option" onclick="event.stopPropagation(); selectUser(this, '${user.user_id}', '${user.name}')">${user.name}</div>`
        ).join('');

        optionsPanel.innerHTML = userOptionsHtml;
    }

    function selectUser(optionElement, userId, userName) {
        const displayElement = optionElement.closest('.custom-select-container').querySelector('.custom-select-display');
        displayElement.textContent = userName;
        displayElement.classList.remove('empty');
        displayElement.dataset.userId = userId;

        const { date, time } = displayElement.dataset;
        if (userId) {
            saveAppointment(date, time, userId, userName);
        } else {
            // 如果 userId 為空，表示要取消預約
            cancelAppointment(date, time);
        }
        closeAllSelects();
    }

    async function saveAppointment(date, time, userId, userName) {
        showStatus('儲存中...', 'info');
        try {
            const response = await fetch('/api/admin/save_appointment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, time, user_id: userId, user_name: userName })
            });
            if (response.ok) {
                showStatus('✅ 預約已儲存', 'success');
            } else { showStatus('❌ 儲存失敗', 'error'); }
        } catch (error) { showStatus('❌ 儲存失敗', 'error'); }
    }

    async function cancelAppointment(date, time) {
        // 後端 save_appointment 傳空值即可取消，前端可選擇性實作專門的取消 API
        // 這裡我們繼續使用 save_appointment 的邏輯
        await saveAppointment(date, time, '', '');
    }

    async function sendWeekReminders(event) {
        if (!confirm('確定要發送整週的預約提醒嗎？')) return;
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '發送中...';
        try {
            const response = await fetch('/api/admin/send_appointment_reminders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'week' })
            });
            const result = await response.json();
            showStatus(`✅ 已發送 ${result.sent_count} 則提醒${result.failed_count > 0 ? `，${result.failed_count} 則失敗` : ''}`);
        } catch (error) {
            showStatus('❌ 發送失敗', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = '📨 發送整週提醒';
        }
    }

    async function sendDayReminders(event, date, dayName) {
        if (!confirm(`確定要發送 ${dayName} 的預約提醒嗎？`)) return;
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '發送中...';
        try {
            const response = await fetch('/api/admin/send_appointment_reminders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'day', date: date })
            });
            const result = await response.json();
            showStatus(`✅ 已發送 ${dayName} 的 ${result.sent_count} 則提醒${result.failed_count > 0 ? `，${result.failed_count} 則失敗` : ''}`);
        } catch (error) {
            showStatus('❌ 發送失敗', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = `📤 發送 ${dayName} 提醒`;
        }
    }

    function showStatus(message, type = 'success') {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = `status-message ${type} show`;
        setTimeout(() => { statusDiv.className = 'status-message'; }, 3000);
    }

    loadInitialData();
</script>
{% endblock %}
