{% extends "base.html" %}

{% block title %}é ç´„ç®¡ç†{% endblock %}

{% block header %}ğŸ“… é ç´„ç®¡ç†{% endblock %}

{% block content %}
<style>
    :root { --primary-color: #667eea; --secondary-color: #764ba2; }
    /* Styles specific to this page */
    .container { width: 98%; max-width: 1800px; margin: 0 auto; }
    .page-header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: #5568d3; }
    .btn-success { background: #48bb78; color: white; }
    .btn-success:hover { background: #38a169; }    
    .schedule-grid { display: flex; justify-content: space-between; gap: 1%; }
    .day-card { flex-basis: 19%; min-width: 0; background: white; border-radius: 10px; padding: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
    .day-header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; }
    .day-header h3 { font-size: 16px; margin-bottom: 5px; }
    .day-header p { font-size: 14px; opacity: 0.9; }
    .time-slots { flex-grow: 1; }
    .time-slot { display: flex; align-items: center; gap: 8px; padding: 5px 6px; margin-bottom: 4px; }
    .time-label { min-width: 50px; font-weight: 500; color: #4a5568; font-size: 13px; }
    .custom-select-container { flex: 1; position: relative; }
    .custom-select-display { width: 100%; padding: 5px; border: 1px solid #cbd5e0; font-size: 13px; border-radius: 4px; background: white; cursor: pointer; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; display: flex; justify-content: space-between; align-items: center; }
    .custom-select-display.empty { color: #888; }
    .custom-select-display::after { content: '\25bc'; font-size: 10px; }
    .custom-select-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #cbd5e0; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .custom-select-options.show { display: block; }
    .custom-option { padding: 8px 10px; cursor: pointer; font-size: 13px; }
    .custom-option:hover { background: #f0f0f0; }
    .custom-option.back-option { color: var(--secondary-color); font-weight: bold; border-bottom: 1px solid #eee; }
    .send-day-btn { margin-top: 10px; width: 100%; padding: 8px; background: #48bb78; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .send-day-btn:hover { background: #38a169; }
    .status-message { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #2d3748; color: white; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: none; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
    .status-message.show { display: block; opacity: 1; }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼šä¸­ç­‰è¢å¹•ï¼ˆä¾‹å¦‚å¹³æ¿ï¼‰ */
    @media (max-width: 1200px) {
        .schedule-grid {
            flex-wrap: wrap;
            gap: 15px;
        }
        .day-card {
            flex-basis: calc(50% - 8px); /* 2æ¬„ä½ˆå±€ */
        }
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼šå°å‹è¢å¹•ï¼ˆä¾‹å¦‚æ‰‹æ©Ÿï¼‰ */
    @media (max-width: 768px) {
        .day-card { flex-basis: 100%; } /* 1æ¬„ä½ˆå±€ */
    }
</style>

<div class="page-header">
    <div class="header-buttons">
        <button class="btn btn-primary" onclick="changeWeek(-1)">â¬…ï¸ ä¸Šä¸€é€±</button>
        <button class="btn btn-primary" onclick="changeWeek(1)">ä¸‹ä¸€é€± â¡ï¸</button>
        <button class="btn btn-primary" onclick="loadInitialData()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        <button class="btn btn-success" onclick="sendWeekReminders(event)">ğŸ“¨ ç™¼é€æ•´é€±æé†’</button>
    </div>
</div>
<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
    <h2 id="weekTitle" style="color: var(--primary-color); font-size: 20px; margin: 0;"></h2>
</div>
<div id="schedule" class="schedule-grid"></div>

<div id="statusMessage" class="status-message"></div>

<script>
    let allUsers = [];
    let groupedUsers = {};
    let weekSchedule = {};
    let currentWeekOffset = 0;
    let openSelect = null;

    document.addEventListener('click', function(e) {
        if (openSelect && !openSelect.contains(e.target)) {
            closeAllSelects();
        }
    });

    function closeAllSelects() {
        document.querySelectorAll('.custom-select-options.show').forEach(el => el.classList.remove('show'));
        openSelect = null;
    }

    async function loadInitialData() {
        showStatus('è¼‰å…¥ä¸­...', 'info');
        await loadUsers();
        await loadSchedule();
    }

    async function loadUsers() {
        try {
            const response = await fetch('/list_users');
            const data = await response.json();
            allUsers = data.allowed_users || [];
            groupedUsers = groupUsersByZhuyin(allUsers);
        } catch (error) {
            showStatus('âŒ ç”¨æˆ¶è¼‰å…¥å¤±æ•—', 'error');
        }
    }

    function groupUsersByZhuyin(users) {
        const groups = users.reduce((acc, user) => {
            const initial = user.zhuyin ? user.zhuyin[0] : '#';
            if (!acc[initial]) acc[initial] = [];
            acc[initial].push(user);
            return acc;
        }, {});
        return groups;
    }

    async function loadSchedule() {
        try {
            const response = await fetch(`/get_week_appointments?offset=${currentWeekOffset}`);
            const data = await response.json();
            weekSchedule = data.week_schedule || {};
            updateWeekTitle();
            renderSchedule();
            showStatus('âœ… è³‡æ–™å·²æ›´æ–°', 'success');
        } catch (error) {
            showStatus('âŒ æ’ç¨‹è¼‰å…¥å¤±æ•—', 'error');
        }
    }

    function updateWeekTitle() {
        const titleEl = document.getElementById('weekTitle');
        if (currentWeekOffset === 0) titleEl.textContent = 'æœ¬é€±é ç´„';
        else if (currentWeekOffset === 1) titleEl.textContent = 'ä¸‹é€±é ç´„';
        else if (currentWeekOffset === -1) titleEl.textContent = 'ä¸Šé€±é ç´„';
        else if (currentWeekOffset > 1) titleEl.textContent = `æœªä¾†ç¬¬ ${currentWeekOffset} é€±`;
        else titleEl.textContent = `éå»ç¬¬ ${Math.abs(currentWeekOffset)} é€±`;
    }

    function changeWeek(offset) {
        currentWeekOffset += offset;
        loadSchedule();
    }

    function renderSchedule() {
        const scheduleDiv = document.getElementById('schedule');
        scheduleDiv.innerHTML = '';
        const days = Object.values(weekSchedule);
        if (days.length === 0) {
            scheduleDiv.innerHTML = '<p>ç„¡é ç´„è³‡æ–™</p>';
            return;
        }

        for (const dayData of days) {
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            const { date_info, appointments } = dayData;

            let timeSlotsHtml = Object.entries(appointments).map(([time, apt]) => {
                const user = allUsers.find(u => u.user_id === apt.user_id);
                return `
                    <div class="time-slot">
                        <span class="time-label">${time}</span>
                        <div class="custom-select-container">
                            ${generateCustomSelect(date_info.date, time, user)}
                        </div>
                    </div>
                `;
            }).join('');

            dayCard.innerHTML = `
                <div class="day-header"><h3>${date_info.day_name}</h3><p>${date_info.display}</p></div>
                <div class="time-slots">${timeSlotsHtml}</div>
                <button class="send-day-btn" onclick="sendDayReminders(event, '${date_info.date}', '${date_info.day_name}')">ğŸ“¤ ç™¼é€ ${date_info.day_name} æé†’</button>   
            `;
            scheduleDiv.appendChild(dayCard);
        }
    }

    function generateCustomSelect(date, time, user) {
        const displayText = user ? user.name : '-- æœªé ç´„ --';
        const displayClass = user ? '' : 'empty';
        const userId = user ? user.user_id : '';
        return `
            <div class="custom-select-display ${displayClass}"
                 data-date="${date}" data-time="${time}" data-user-id="${userId}"
                 onclick="toggleDropdown(this)">
                ${displayText}
            </div>
            <div class="custom-select-options"></div>
        `;
    }

    function toggleDropdown(displayElement) {
        const optionsPanel = displayElement.nextElementSibling;
        const wasOpen = optionsPanel.classList.contains('show');
        closeAllSelects();
        if (!wasOpen) {
            optionsPanel.classList.add('show');
            openSelect = displayElement.parentElement;
            renderZhuyinOptions(displayElement);
        }
    }

    function renderZhuyinOptions(displayElement) {
        const optionsPanel = displayElement.nextElementSibling;
        const zhuyinOrder = 'ã„…ã„†ã„‡ã„ˆã„‰ã„Šã„‹ã„Œã„ã„ã„ã„ã„‘ã„’ã„“ã„”ã„•ã„–ã„—ã„˜ã„™ã„§ã„¨ã„©ã„šã„›ã„œã„ã„ã„Ÿã„ ã„¡ã„¢ã„£ã„¤ã„¥ã„¦#';
        const sortedKeys = Object.keys(groupedUsers).sort((a, b) => {
            if (a === '#') return 1;
            if (b === '#') return -1;
            return zhuyinOrder.indexOf(a) - zhuyinOrder.indexOf(b);
        });

        let optionsHtml = `<div class="custom-option" onclick="event.stopPropagation(); selectUser(this, '', '-- æœªé ç´„ --')">-- æœªé ç´„ --</div>`;
        optionsHtml += sortedKeys.map(key =>
            `<div class="custom-option" onclick="event.stopPropagation(); renderUserOptions(this, '${key}')">${key}</div>`
        ).join('');
        optionsPanel.innerHTML = optionsHtml;
    }

    function renderUserOptions(optionElement, zhuyinInitial) {
        const displayElement = optionElement.closest('.custom-select-container').querySelector('.custom-select-display');
        const optionsPanel = displayElement.nextElementSibling;
        const usersInGroup = groupedUsers[zhuyinInitial] || [];

        let userOptionsHtml = `<div class="custom-option back-option" onclick="event.stopPropagation(); renderZhuyinOptions(this.closest('.custom-select-container').querySelector('.custom-select-display'))">â† è¿”å›æ³¨éŸ³</div>`;
        userOptionsHtml += usersInGroup.map(user =>
            `<div class="custom-option" onclick="event.stopPropagation(); selectUser(this, '${user.user_id}', '${user.name}')">${user.name}</div>`
        ).join('');

        optionsPanel.innerHTML = userOptionsHtml;
    }

    function selectUser(optionElement, userId, userName) {
        const displayElement = optionElement.closest('.custom-select-container').querySelector('.custom-select-display');
        displayElement.textContent = userName;
        displayElement.classList.remove('empty');
        displayElement.dataset.userId = userId;

        const { date, time } = displayElement.dataset;
        if (userId) {
            saveAppointment(date, time, userId, userName);
        } else {
            // å¦‚æœ userId ç‚ºç©ºï¼Œè¡¨ç¤ºè¦å–æ¶ˆé ç´„
            cancelAppointment(date, time);
        }
        closeAllSelects();
    }

    async function saveAppointment(date, time, userId, userName) {
        showStatus('å„²å­˜ä¸­...', 'info');
        try {
            const response = await fetch('/save_appointment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, time, user_id: userId, user_name: userName })
            });
            if (response.ok) {
                showStatus('âœ… é ç´„å·²å„²å­˜', 'success');
            } else { showStatus('âŒ å„²å­˜å¤±æ•—', 'error'); }
        } catch (error) { showStatus('âŒ å„²å­˜å¤±æ•—', 'error'); }
    }

    async function cancelAppointment(date, time) {
        // å¾Œç«¯ save_appointment å‚³ç©ºå€¼å³å¯å–æ¶ˆï¼Œå‰ç«¯å¯é¸æ“‡æ€§å¯¦ä½œå°ˆé–€çš„å–æ¶ˆ API
        // é€™è£¡æˆ‘å€‘ç¹¼çºŒä½¿ç”¨ save_appointment çš„é‚è¼¯
        await saveAppointment(date, time, '', '');
    }

    async function sendWeekReminders(event) {
        if (!confirm('ç¢ºå®šè¦ç™¼é€æ•´é€±çš„é ç´„æé†’å—ï¼Ÿ')) return;
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'ç™¼é€ä¸­...';
        try {
            const response = await fetch('/send_appointment_reminders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'week' })
            });
            const result = await response.json();
            showStatus(`âœ… å·²ç™¼é€ ${result.sent_count} å‰‡æé†’${result.failed_count > 0 ? `ï¼Œ${result.failed_count} å‰‡å¤±æ•—` : ''}`);
        } catch (error) {
            showStatus('âŒ ç™¼é€å¤±æ•—', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ“¨ ç™¼é€æ•´é€±æé†’';
        }
    }

    async function sendDayReminders(event, date, dayName) {
        if (!confirm(`ç¢ºå®šè¦ç™¼é€ ${dayName} çš„é ç´„æé†’å—ï¼Ÿ`)) return;
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'ç™¼é€ä¸­...';
        try {
            const response = await fetch('/send_appointment_reminders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'day', date: date })
            });
            const result = await response.json();
            showStatus(`âœ… å·²ç™¼é€ ${dayName} çš„ ${result.sent_count} å‰‡æé†’${result.failed_count > 0 ? `ï¼Œ${result.failed_count} å‰‡å¤±æ•—` : ''}`);
        } catch (error) {
            showStatus('âŒ ç™¼é€å¤±æ•—', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = `ğŸ“¤ ç™¼é€ ${dayName} æé†’`;
        }
    }

    function showStatus(message, type = 'success') {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = `status-message ${type} show`;
        setTimeout(() => { statusDiv.className = 'status-message'; }, 3000);
    }

    loadInitialData();
</script>
{% endblock %}
