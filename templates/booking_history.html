{% extends "portal_base.html" %}
{% block title %}我的預約紀錄{% endblock %}
{% block header %}我的預約紀錄{% endblock %}

{% block content %}


<div class="container my-4">
    <div id="message-container"></div>

    {% if not user %}
    <div class="alert alert-warning">請先<a href="{{ url_for('login') }}">登入</a>以查看您的預約紀錄。</div>
    {% else %}
        {% if future_appointments %}
        <h4>進行中的預約</h4>
        <ul class="appointment-list">
            {% for apt in future_appointments %}
            <li class="appointment-item">
                <div class="appointment-details">
                    <div class="appointment-date">{{ apt.formatted_date }} ({{ apt.weekday }})</div>
                    <div class="appointment-time">{{ apt.time }}</div>
                    <div class="appointment-meta">預約建立於: {{ apt.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
                <div class="appointment-actions d-flex flex-column align-items-end gap-2">
                    <span class="appointment-status status-confirmed">已預約</span>
                    <button class="btn btn-sm btn-cancel" 
                            data-appointment-id="{{ apt.id }}" 
                            data-appointment-date="{{ apt.formatted_date }}" 
                            data-appointment-time="{{ apt.time }}">取消預約</button>
                </div>
            </li>
            {% endfor %}
        </ul>
        <hr class="my-4">
        {% endif %}

        <h4>歷史預約紀錄</h4>
        {% if past_appointments %}
        <ul class="appointment-list">
            {% for apt in past_appointments %}
            <li class="appointment-item">
                <div class="appointment-details">
                    <div class="appointment-date">{{ apt.formatted_date }} ({{ apt.weekday }})</div>
                    <div class="appointment-time">{{ apt.time }}</div>
                    <div class="appointment-meta">預約建立於: {{ apt.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
                <div class="appointment-actions">
                    <span class="appointment-status status-completed">已完成</span>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="alert alert-info">目前沒有歷史預約紀錄。</div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type = 'info') {
        const container = document.getElementById('message-container');
        const alertEl = document.createElement('div');
        alertEl.className = `alert alert-${type} alert-dismissible fade show`;
        alertEl.role = 'alert';
        alertEl.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        container.appendChild(alertEl);
        setTimeout(() => {
            const alertInstance = bootstrap.Alert.getOrCreateInstance(alertEl);
            if (alertInstance) alertInstance.close();
        }, 5000);
    }

    async function cancelAppointment(appointmentId, date, time) {
        if (!confirm(`您確定要取消 ${date} ${time} 的預約嗎？`)) return;

        try {
            const response = await fetch("{{ url_for('api_cancel_my_appointment') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ appointment_id: appointmentId }),
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                showAlert(result.message || '取消失敗，請重試。', 'danger');
            }
        } catch (error) {
            showAlert('發生網路錯誤，請稍後再試。', 'danger');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const appointmentLists = document.querySelectorAll('.appointment-list');
        appointmentLists.forEach(list => {
            list.addEventListener('click', function(event) {
                const button = event.target.closest('.btn-cancel');
                if (button) {
                    const appointmentId = button.dataset.appointmentId;
                    const date = button.dataset.appointmentDate;
                    const time = button.dataset.appointmentTime;
                    cancelAppointment(appointmentId, date, time);
                }
            });
        });
    });
</script>
{% endblock %}