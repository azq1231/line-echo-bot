{% extends "base.html" %}

{% block title %}休診管理{% endblock %}

{% block header %}😴 休診管理{% endblock %}

{% block content %}


<div class="card">
    <h2>➕ 新增休診日期</h2>
    <form onsubmit="addClosedDay(event)">
        <div class="form-group">
            <label for="closedDate">日期</label>
            <input type="date" id="closedDate" required>
        </div>
        <div class="form-group">
            <label for="closedReason">原因（選填）</label>
            <input type="text" id="closedReason" placeholder="例如：國定假日、臨時休診">
        </div>
        <button type="submit" class="btn btn-primary">新增休診</button>
    </form>
</div>

<div class="card">
    <h2>📋 休診日期列表</h2>
    <div id="closedDaysList" class="closed-days-list"></div>
</div>

<div id="statusMessage" class="status-message"></div>

<script>
    async function loadClosedDays() {
        try {
            const response = await fetch('/api/admin/closed_days');
            const data = await response.json();
            const closedDays = data.closed_days || [];
            const listDiv = document.getElementById('closedDaysList');
            if (closedDays.length === 0) {
                listDiv.innerHTML = '<p style="color: #718096; text-align: center;">目前沒有休診日期</p>';
                return;
            }
            listDiv.innerHTML = closedDays.map(day => `
                <div class="closed-day-item">
                    <div class="closed-day-info">
                        <div class="closed-day-date">📅 ${formatDate(day.date)}</div>
                        <div class="closed-day-reason">${day.reason || '休診'}</div>
                    </div>
                    <button class="btn btn-danger" onclick="removeClosedDay('${day.date}')">
                        刪除
                    </button>
                </div>
            `).join('');
        } catch (error) {
            showStatus('❌ 載入失敗', 'error');
        }
    }

    async function addClosedDay(event) {
        event.preventDefault();
        const date = document.getElementById('closedDate').value;
        const reason = document.getElementById('closedReason').value || '休診';
        if (!date) {
            showStatus('❌ 請選擇日期', 'error');
            return;
        }
        try {
            const response = await fetch('/api/admin/set_closed_day', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, reason })
            });
            if (!response.ok) {
                const error = await response.json();
                showStatus(`❌ ${error.message}`, 'error');
                return;
            }
            const result = await response.json();
            showStatus(result.message);
            document.getElementById('closedDate').value = '';
            document.getElementById('closedReason').value = '';
            loadClosedDays();
        } catch (error) {
            showStatus('❌ 新增失敗', 'error');
        }
    }

    async function removeClosedDay(date) {
        if (!confirm(`確定要刪除 ${formatDate(date)} 的休診設定嗎？`)) {
            return;
        }
        try {
            const response = await fetch('/api/admin/remove_closed_day', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date })
            });
            if (!response.ok) {
                const error = await response.json();
                showStatus(`❌ ${error.message}`, 'error');
                return;
            }
            showStatus('✅ 已移除休診設定');
            loadClosedDays();
        } catch (error) {
            showStatus('❌ 刪除失敗', 'error');
        }
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        const weekday = weekdays[date.getDay()];
        return `${year}年${month}月${day}日 (${weekday})`;
    }

    function showStatus(message, type = 'success') {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = 'status-message show';
        setTimeout(() => {
            statusDiv.className = 'status-message';
        }, 3000);
    }

    document.getElementById('closedDate').min = new Date().toISOString().split('T')[0];
    loadClosedDays();
</script>
{% endblock %}