{% extends "base.html" %}

{% block title %}ä¼‘è¨ºç®¡ç†{% endblock %}

{% block header %}ğŸ˜´ ä¼‘è¨ºç®¡ç†{% endblock %}

{% block content %}


<div class="card">
    <h2>â• æ–°å¢ä¼‘è¨ºæ—¥æœŸ</h2>
    <form onsubmit="addClosedDay(event)">
        <div class="form-group">
            <label for="closedDate">æ—¥æœŸ</label>
            <input type="date" id="closedDate" required>
        </div>
        <div class="form-group">
            <label for="closedReason">åŸå› ï¼ˆé¸å¡«ï¼‰</label>
            <input type="text" id="closedReason" placeholder="ä¾‹å¦‚ï¼šåœ‹å®šå‡æ—¥ã€è‡¨æ™‚ä¼‘è¨º">
        </div>
        <button type="submit" class="btn btn-primary">æ–°å¢ä¼‘è¨º</button>
    </form>
</div>

<div class="card">
    <h2>ğŸ“‹ ä¼‘è¨ºæ—¥æœŸåˆ—è¡¨</h2>
    <div id="closedDaysList" class="closed-days-list"></div>
</div>

<div id="statusMessage" class="status-message"></div>

<script>
    async function loadClosedDays() {
        try {
            const response = await fetch('/api/admin/closed_days');
            const data = await response.json();
            const closedDays = data.closed_days || [];
            const listDiv = document.getElementById('closedDaysList');
            if (closedDays.length === 0) {
                listDiv.innerHTML = '<p style="color: #718096; text-align: center;">ç›®å‰æ²’æœ‰ä¼‘è¨ºæ—¥æœŸ</p>';
                return;
            }
            listDiv.innerHTML = closedDays.map(day => `
                <div class="closed-day-item">
                    <div class="closed-day-info">
                        <div class="closed-day-date">ğŸ“… ${formatDate(day.date)}</div>
                        <div class="closed-day-reason">${day.reason || 'ä¼‘è¨º'}</div>
                    </div>
                    <button class="btn btn-danger" onclick="removeClosedDay('${day.date}')">
                        åˆªé™¤
                    </button>
                </div>
            `).join('');
        } catch (error) {
            showStatus('âŒ è¼‰å…¥å¤±æ•—', 'error');
        }
    }

    async function addClosedDay(event) {
        event.preventDefault();
        const date = document.getElementById('closedDate').value;
        const reason = document.getElementById('closedReason').value || 'ä¼‘è¨º';
        if (!date) {
            showStatus('âŒ è«‹é¸æ“‡æ—¥æœŸ', 'error');
            return;
        }
        try {
            const response = await fetch('/api/admin/set_closed_day', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, reason })
            });
            if (!response.ok) {
                const error = await response.json();
                showStatus(`âŒ ${error.message}`, 'error');
                return;
            }
            const result = await response.json();
            showStatus(result.message);
            document.getElementById('closedDate').value = '';
            document.getElementById('closedReason').value = '';
            loadClosedDays();
        } catch (error) {
            showStatus('âŒ æ–°å¢å¤±æ•—', 'error');
        }
    }

    async function removeClosedDay(date) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${formatDate(date)} çš„ä¼‘è¨ºè¨­å®šå—ï¼Ÿ`)) {
            return;
        }
        try {
            const response = await fetch('/api/admin/remove_closed_day', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date })
            });
            if (!response.ok) {
                const error = await response.json();
                showStatus(`âŒ ${error.message}`, 'error');
                return;
            }
            showStatus('âœ… å·²ç§»é™¤ä¼‘è¨ºè¨­å®š');
            loadClosedDays();
        } catch (error) {
            showStatus('âŒ åˆªé™¤å¤±æ•—', 'error');
        }
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
        const weekday = weekdays[date.getDay()];
        return `${year}å¹´${month}æœˆ${day}æ—¥ (${weekday})`;
    }

    function showStatus(message, type = 'success') {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = 'status-message show';
        setTimeout(() => {
            statusDiv.className = 'status-message';
        }, 3000);
    }

    document.getElementById('closedDate').min = new Date().toISOString().split('T')[0];
    loadClosedDays();
</script>
{% endblock %}