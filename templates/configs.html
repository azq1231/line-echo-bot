{% extends "base.html" %}
{% block title %}系統設定{% endblock %}
{% block header %}⚙️ 系統設定{% endblock %}

{% block content %}
<style>
    .config-item {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    .config-item h5 {
        margin-bottom: 15px;
    }
    .form-label {
        font-weight: 500;
    }
    #message-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        width: 90%;
        max-width: 500px;
    }
</style>

<div class="container my-4">
    <div id="message-container"></div>

    <div class="config-item">
        <h5>預約設定</h5>
        <div class="mb-3">
            <label for="bookingWindow" class="form-label">線上預約開放週數</label>
            <select class="form-select" id="bookingWindow">
                <option value="2" {% if configs.booking_window_weeks == '2' %}selected{% endif %}>2 週</option>
                <option value="4" {% if configs.booking_window_weeks == '4' %}selected{% endif %}>4 週</option>
            </select>
            <div class="form-text">設定使用者在線上預約頁面，最多可以看到未來幾週的時段。</div>
        </div>
        <button class="btn btn-primary" onclick="saveConfig('booking_window_weeks', 'bookingWindow')">儲存設定</button>
    </div>

    <div class="config-item">
        <h5>管理設定</h5>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" role="switch" id="allowDeletionSwitch" {% if configs.allow_user_deletion == 'true' %}checked{% endif %}>
            <label class="form-check-label" for="allowDeletionSwitch">允許從管理介面刪除用戶 (危險操作)</label>
        </div>
        <button class="btn btn-primary" onclick="saveDeletionSetting()">儲存設定</button>
    </div>

    <div class="config-item">
        <h5>功能模組開關</h5>
        <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" role="switch" id="scheduleSwitch" {% if configs.feature_schedule_enabled == 'true' %}checked{% endif %} onchange="saveFeatureToggle('feature_schedule_enabled', this.checked)">
            <label class="form-check-label" for="scheduleSwitch">啟用「排程管理」功能</label>
        </div>
        <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" role="switch" id="closedDaysSwitch" {% if configs.feature_closed_days_enabled == 'true' %}checked{% endif %} onchange="saveFeatureToggle('feature_closed_days_enabled', this.checked)">
            <label class="form-check-label" for="closedDaysSwitch">啟用「休診管理」功能</label>
        </div>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" role="switch" id="bookingSwitch" {% if configs.feature_booking_enabled == 'true' %}checked{% endif %} onchange="saveFeatureToggle('feature_booking_enabled', this.checked)">
            <label class="form-check-label" for="bookingSwitch">啟用「線上預約」功能</label>
        </div>
        <div class="form-text">
            關閉功能後，對應的管理頁面將被隱藏。
        </div>
    </div>

    <div class="config-item">
        <h5>自動提醒設定</h5>        
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" role="switch" id="autoReminderDailySwitch" {% if configs.auto_reminder_daily_enabled == 'true' %}checked{% endif %} onchange="saveFeatureToggle('auto_reminder_daily_enabled', this.checked)">
                            <label class="form-check-label" for="autoReminderDailySwitch">啟用每日自動提醒</label>
                        </div>
                        <label for="dailyTime" class="form-label">本日提醒時間</label>
                        <select class="form-select" id="dailyTime" onchange="saveConfig('auto_reminder_daily_time', 'dailyTime')">
                            {% for i in range(7, 13) %}
                            <option value="{{ '%02d:00'|format(i) }}" {% if configs.auto_reminder_daily_time == '%02d:00'|format(i) %}selected{% endif %}>{{ '%02d:00'|format(i) }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text mt-2">每日自動發送「當天」的預約提醒。</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" role="switch" id="autoReminderWeeklySwitch" {% if configs.auto_reminder_weekly_enabled == 'true' %}checked{% endif %} onchange="saveFeatureToggle('auto_reminder_weekly_enabled', this.checked)">
                            <label class="form-check-label" for="autoReminderWeeklySwitch">啟用每週自動提醒</label>
                        </div>
                        <label for="weeklyDay" class="form-label">本週提醒時間</label>
                        <div class="input-group">
                            <select class="form-select" id="weeklyDay" onchange="saveConfig('auto_reminder_weekly_day', 'weeklyDay')">
                                <option value="sun" {% if configs.auto_reminder_weekly_day == 'sun' %}selected{% endif %}>每週日</option>
                                <option value="sat" {% if configs.auto_reminder_weekly_day == 'sat' %}selected{% endif %}>每週六</option>
                            </select>
                            <select class="form-select" id="weeklyTime" onchange="saveConfig('auto_reminder_weekly_time', 'weeklyTime')">
                                {% for i in range(18, 23) %}
                                <option value="{{ '%02d:00'|format(i) }}" {% if configs.auto_reminder_weekly_time == '%02d:00'|format(i) %}selected{% endif %}>{{ '%02d:00'|format(i) }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-text mt-2">每週自動發送「下週」的預約提醒。</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="config-item">
        <h5>訊息範本設定</h5>
        <div class="mb-3">
            <label for="message_template_reminder" class="form-label"><strong>預約提醒訊息範本</strong></label>
            <textarea class="form-control" id="message_template_reminder" rows="5">{{ configs.message_template_reminder }}</textarea>
            <div class="form-text">
                <p class="mb-1">這是發送預約提醒時的訊息內容。可用的變數：</p>
                <ul>
                    <li><code>{user_name}</code>: 使用者的名稱 (例如：林小明)</li>
                    <li><code>{date_keyword}</code>: 日期關鍵字 (例如：今天、明天、 週一)</li>
                    <li><code>{date}</code>: 格式化的日期 (例如：10/29)</li>
                    <li><code>{weekday}</code>: 與 {date_keyword} 內容相同，為向下相容保留</li>
                    <li><code>{time_slots}</code>: 當天所有預約時段的條列式清單</li>
                </ul>
                <p class="mb-0"><strong>範例：</strong><br>
                如果範本設為 <code>您好，提醒您{date_keyword} ({date}) 有預約以下時段：<br>{time_slots}</code><br>
                系統將發送多時段的合併提醒。</p>
            </div>
        </div>
        <button class="btn btn-primary" onclick="saveConfig('message_template_reminder', 'message_template_reminder')">儲存訊息範本</button>
    </div>

    <div class="config-item">
        <h5>管理員設定</h5>
        <div class="mb-3">
            <label class="form-label">目前管理員</label>
            {% if admins %}
                <ul class="list-group">
                    {% for admin in admins %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <img src="{{ url_for('user_avatar', user_id=admin.user_id) }}" class="rounded-circle me-2" width="30" height="30" alt="Avatar">
                                {{ admin.name }}
                            </span>
                            <small class="text-muted">{{ admin.user_id }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">目前沒有任何管理員。</p>
            {% endif %}
        </div>

        <hr>

        <form action="{{ url_for('set_admin_status') }}" method="POST">
            <div class="mb-3">
                <label for="userIdInput" class="form-label">LINE User ID</label>
                <input type="text" class="form-control" id="userIdInput" name="user_id" placeholder="請輸入要變更權限的 LINE User ID" required>
                <div class="form-text">請確保該用戶至少與您的 LINE 官方帳號互動過一次。</div>
            </div>
            <div class="mb-3">
                <label for="actionSelect" class="form-label">操作</label>
                <select class="form-select" id="actionSelect" name="action">
                    <option value="add">新增為管理員</option>
                    <option value="remove">移除管理員權限</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">執行變更</button>
        </form>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type = 'info') {
        const container = document.getElementById('message-container');
        const alertEl = document.createElement('div');
        alertEl.className = `alert alert-${type} alert-dismissible fade show`;
        alertEl.role = 'alert';
        alertEl.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        container.appendChild(alertEl);
        setTimeout(() => {
            const alertInstance = bootstrap.Alert.getOrCreateInstance(alertEl);
            if (alertInstance) {
                alertInstance.close();
            }
        }, 3000);
    }

    async function saveConfig(key, elementId) {
        const value = document.getElementById(elementId).value;
        await updateConfig(key, value);
    }

    async function saveDeletionSetting() {
        const isEnabled = document.getElementById('allowDeletionSwitch').checked;
        await updateConfig('allow_user_deletion', isEnabled ? 'true' : 'false');
    }

    async function saveFeatureToggle(key, isEnabled) {
        await updateConfig(key, isEnabled ? 'true' : 'false');
    }

    async function updateConfig(key, value) {
        try {
            const response = await fetch("{{ url_for('set_config_api') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: key, value: value })
            });
            // 嘗試先讀取為純文字，再解析為 JSON（若伺服器回傳 HTML 錯誤頁面或其他非 JSON，將能在 console 中看到原始內容）
            const text = await response.text();
            let result = null;
            try {
                result = JSON.parse(text);
            } catch (e) {
                console.error('非 JSON 回應:', text);
            }

            if (response.ok) {
                const msg = (result && result.message) ? result.message : '配置已更新';
                console.log('set_config 成功:', response.status, msg);
                showAlert(msg, 'success');
            } else {
                const errMsg = (result && result.message) ? result.message : `更新失敗 (HTTP ${response.status})`;
                console.error('set_config 錯誤:', response.status, text);
                showAlert(errMsg, 'danger');
            }
        } catch (error) {
            console.error('fetch 發生錯誤:', error);
            showAlert('網路錯誤，請稍後再試。', 'danger');
        }
    }
</script>
{% endblock %}