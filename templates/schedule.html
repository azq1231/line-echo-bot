{% extends "base.html" %}

{% block title %}LINE Bot æ’ç¨‹ç®¡ç†{% endblock %}

{% block header %}ğŸ“… LINE Bot æ’ç¨‹ç®¡ç†{% endblock %}

{% block content %}


<div id="message" class="message"></div>

<div class="section">
    <h2>â• æ–°å¢æ’ç¨‹</h2>
    <div class="form-group">
        <label for="userSelect">é¸æ“‡ç”¨æˆ¶</label>
        <select id="userSelect">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
    </div>
    <div class="form-group">
        <label for="sendTime">ç™¼é€æ™‚é–“</label>
        <input type="datetime-local" id="sendTime">
    </div>
    <div class="form-group">
        <label for="messageText">è¨Šæ¯å…§å®¹</label>
        <textarea id="messageText" placeholder="è¼¸å…¥è¦ç™¼é€çš„è¨Šæ¯..."></textarea>
    </div>
    <button onclick="addSchedule()">æ–°å¢æ’ç¨‹</button>
</div>

<div class="section">
    <h2>ğŸ“‹ æ’ç¨‹åˆ—è¡¨ (<span id="scheduleCount">0</span>)</h2>
    <ul id="scheduleList" class="schedule-list">
        <li class="empty-state">è¼‰å…¥ä¸­...</li>
    </ul>
</div>

<script>
    function showMessage(text, type) {
        const msgEl = document.getElementById('message');
        msgEl.textContent = text;
        msgEl.className = `message ${type}`;
        msgEl.style.display = 'block';
        setTimeout(() => {
            msgEl.style.display = 'none';
        }, 3000);
    }

    async function loadUsers() {
        try {
            const response = await fetch('/admin/list_users');
            const data = await response.json();
            const select = document.getElementById('userSelect');
            if (data.allowed_users && data.allowed_users.length > 0) {
                select.innerHTML = '<option value="">è«‹é¸æ“‡ç”¨æˆ¶</option>';
                data.allowed_users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.user_id;
                    option.textContent = `${user.name} (${user.user_id})`;
                    option.dataset.name = user.name;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">æ²’æœ‰å¯ç”¨çš„ç”¨æˆ¶</option>';
            }
        } catch (error) {
            console.error('è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', error);
        }
    }

    async function loadSchedules() {
        try {
            const response = await fetch('/admin/list_schedules');
            const data = await response.json();
            const listEl = document.getElementById('scheduleList');
            const countEl = document.getElementById('scheduleCount');
            countEl.textContent = data.count;
            if (data.schedules && data.schedules.length > 0) {
                listEl.innerHTML = '';
                data.schedules.forEach(schedule => {
                    // åµéŒ¯ï¼šåœ¨ç€è¦½å™¨æ§åˆ¶å°å°å‡ºå¾å¾Œç«¯æ”¶åˆ°çš„ schedule ç‰©ä»¶
                    console.log('Processing schedule object:', schedule);

                    const li = document.createElement('li'); // å»ºç«‹ li å…ƒç´ 
                    li.className = 'schedule-item'; // è¨­å®š class

                    // å»ºç«‹ schedule-info div
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'schedule-info';

                    // æ±ºå®šç‹€æ…‹çš„ class å’Œæ–‡å­—
                    const statusMap = {
                        'sent': { class: 'status-sent', text: 'å·²ç™¼é€' },
                        'failed': { class: 'status-failed', text: 'ç™¼é€å¤±æ•—' },
                        'pending': { class: 'status-pending', text: 'å¾…ç™¼é€' }
                    };
                    const statusInfo = statusMap[schedule.status] || statusMap['pending'];

                    // ä½¿ç”¨ innerHTML å¡«å…… infoDiv çš„å…§å®¹
                    infoDiv.innerHTML = `
                        <div class="schedule-user">${schedule.user_name}</div>
                        <div class="schedule-time">â° ${schedule.send_time}</div>
                        <div class="schedule-message">${schedule.message}</div>
                        <span class="schedule-status ${statusInfo.class}">${statusInfo.text}</span>
                    `;

                    // å°‡ infoDiv åŠ å…¥ li
                    li.appendChild(infoDiv);

                    // å¦‚æœç‹€æ…‹æ˜¯ pendingï¼Œæ‰å»ºç«‹ä¸¦åŠ å…¥åˆªé™¤æŒ‰éˆ•
                    if (schedule.status === 'pending') {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = 'åˆªé™¤';
                        // çµ‚æ¥µæ‰‹æ®µï¼šç›´æ¥å°‡ ID å¯«å…¥ onclick äº‹ä»¶
                        deleteBtn.setAttribute('onclick', `deleteSchedule(${schedule.id})`);
                        // å°‡æŒ‰éˆ•åŠ å…¥ li
                        li.appendChild(deleteBtn);
                    }

                    // æœ€å¾Œå°‡å®Œæ•´çš„ li åŠ å…¥åˆ—è¡¨
                    listEl.appendChild(li);
                });
            } else {
                listEl.innerHTML = '<li class="empty-state">å°šç„¡æ’ç¨‹</li>';
            }
        } catch (error) {
            console.error('è¼‰å…¥æ’ç¨‹å¤±æ•—:', error);
        }
    }

    async function addSchedule() {
        const select = document.getElementById('userSelect');
        const userId = select.value;
        const userName = select.options[select.selectedIndex]?.dataset?.name || 'æœªçŸ¥';
        const sendTime = document.getElementById('sendTime').value;
        const message = document.getElementById('messageText').value;
        if (!userId) {
            showMessage('è«‹é¸æ“‡ç”¨æˆ¶', 'error');
            return;
        }
        if (!sendTime) {
            showMessage('è«‹é¸æ“‡ç™¼é€æ™‚é–“', 'error');
            return;
        }
        if (!message.trim()) {
            showMessage('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹', 'error');
            return;
        }
        const formattedTime = sendTime.replace('T', ' ');
        try {
            const response = await fetch('/admin/add_schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    user_name: userName,
                    send_time: formattedTime,
                    message: message
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showMessage('æ’ç¨‹å·²æ–°å¢æˆåŠŸï¼', 'success');
                document.getElementById('sendTime').value = '';
                document.getElementById('messageText').value = '';
                loadSchedules();
            } else {
                showMessage(data.message || 'æ–°å¢å¤±æ•—', 'error');
            }
        } catch (error) {
            console.error('æ–°å¢æ’ç¨‹å¤±æ•—:', error);
            showMessage('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
    }

    async function deleteSchedule(scheduleId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ’ç¨‹å—ï¼Ÿ')) {
            return;
        }
        try {
            const response = await fetch(`/admin/delete_schedule/${scheduleId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            if (data.status === 'success') {
                showMessage('æ’ç¨‹å·²åˆªé™¤', 'success');
                loadSchedules();
            } else {
                showMessage('åˆªé™¤å¤±æ•—', 'error');
            }
        } catch (error) {
            console.error('åˆªé™¤æ’ç¨‹å¤±æ•—:', error);
            showMessage('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
    }

    // ç”±æ–¼ onclick å·²ç›´æ¥å‘¼å« deleteScheduleï¼Œé€™å€‹äº‹ä»¶ç›£è½å™¨ä¸å†éœ€è¦è™•ç†åˆªé™¤é‚è¼¯
    document.getElementById('scheduleList').addEventListener('click', function(event) {
        // ç¢ºä¿é»æ“Šçš„æ˜¯åˆªé™¤æŒ‰éˆ•
        if (event.target.classList.contains('delete-btn')) {
            // const scheduleId = event.target.getAttribute('data-schedule-id');
            // if (scheduleId) {
            //     deleteSchedule(scheduleId);
            // }
        }
    });

    loadUsers();
    loadSchedules();
    setInterval(loadSchedules, 10000);
</script>
{% endblock %}