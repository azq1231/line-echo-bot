{% extends "base.html" %}

{% block title %}LINE Bot æ’ç¨‹ç®¡ç†{% endblock %}

{% block header %}ğŸ“… LINE Bot æ’ç¨‹ç®¡ç†{% endblock %}

{% block content %}
<style>
    .section {
        margin-bottom: 40px;
    }
    .section h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 20px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
    }
    select, input[type="datetime-local"], textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
        font-family: inherit;
    }
    select:focus, input:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
    }
    textarea {
        resize: vertical;
        min-height: 100px;
    }
    button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .schedule-list {
        list-style: none;
    }
    .schedule-item {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: start;
        transition: background-color 0.2s;
    }
    .schedule-item .schedule-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 80px; /* ç¢ºä¿æŒ‰éˆ•å¯¬åº¦ä¸€è‡´ */
    }
    .schedule-item:hover {
        background: #f0f0f0;
    }
    .schedule-info {
        flex: 1;
    }
    .schedule-user {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }
    .schedule-time {
        color: #667eea;
        font-size: 14px;
        margin-bottom: 8px;
    }
    .schedule-message {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
    }
    .schedule-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        margin-top: 8px;
    }
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    .status-sent {
        background: #d4edda;
        color: #155724;
    }
    .status-failed {
        background: #f8d7da;
        color: #721c24;
    }
    .action-btn {
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
        width: 100%;
        text-align: center;
    }
    .delete-btn {
        background: #dc3545;
    }
    .delete-btn:hover {
        background: #c82333;
    }
    .edit-btn {
        background: #6c757d;
    }
    .edit-btn:hover {
        background: #5a6268;
    }
    .save-btn {
        background: #28a745;
    }
    .save-btn:hover {
        background: #218838;
    }
    .message {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
    .message.success {
        background: #d4edda;
        color: #155724;
    }
    .message.error {
        background: #f8d7da;
        color: #721c24;
    }
    .empty-state {
        text-align: center;
        color: #999;
        padding: 40px;
    }
    @media (max-width: 768px) {
        button { width: 100%; }
        .schedule-item { flex-direction: column; align-items: flex-start; gap: 12px; }
        .schedule-item .schedule-actions { width: 100%; }
    }
</style>

<div id="message" class="message"></div>

<div class="section">
    <h2>â• æ–°å¢æ’ç¨‹</h2>
    <div class="form-group">
        <label for="userSelect">é¸æ“‡ç”¨æˆ¶</label>
        <select id="userSelect">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
    </div>
    <div class="form-group">
        <label for="sendTime">ç™¼é€æ™‚é–“</label>
        <input type="datetime-local" id="sendTime">
    </div>
    <div class="form-group">
        <label for="messageText">è¨Šæ¯å…§å®¹</label>
        <textarea id="messageText" placeholder="è¼¸å…¥è¦ç™¼é€çš„è¨Šæ¯..."></textarea>
    </div>
    <button onclick="addSchedule()">æ–°å¢æ’ç¨‹</button>
</div>

<div class="section">
    <h2>ğŸ“‹ æ’ç¨‹åˆ—è¡¨ (<span id="scheduleCount">0</span>)</h2>
    <ul id="scheduleList" class="schedule-list">
        <li class="empty-state">è¼‰å…¥ä¸­...</li>
    </ul>
</div>

    <!-- ç·¨è¼¯æ™‚é–“çš„ Modal (éš±è—) -->
    <div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScheduleModalLabel">ç·¨è¼¯æ’ç¨‹æ™‚é–“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>æ­£åœ¨ç·¨è¼¯çµ¦ <strong id="editingUserName"></strong> çš„æ’ç¨‹ã€‚</p>
                    <div class="form-group">
                        <label for="editSendTime">æ–°çš„ç™¼é€æ™‚é–“</label>
                        <input type="datetime-local" id="editSendTime" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveTimeChangeBtn">å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
    </div>
<script>
    function showMessage(text, type) {
        const msgEl = document.getElementById('message');
        msgEl.textContent = text;
        msgEl.className = `message ${type}`;
        msgEl.style.display = 'block';
        setTimeout(() => {
            msgEl.style.display = 'none';
        }, 3000);
    }

    function formatToTaipei(utcString) {
        if (!utcString) return 'N/A';
        try {
            // ç¢ºä¿å­—ä¸²æ˜¯æ¨™æº– ISO æ ¼å¼ï¼Œä¸¦å¼·åˆ¶è¦–ç‚º UTC
            let isoString = utcString.replace(' ', 'T');
            if (!isoString.includes('Z') && !isoString.match(/[+\-]\d{2}:\d{2}$/)) {
                isoString += 'Z';
            }
            const date = new Date(isoString);
            if (isNaN(date)) throw new Error('Invalid date');

            return date.toLocaleString('zh-TW', {
                timeZone: 'Asia/Taipei',
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).replace(/\//g, '-');
        } catch (e) {
            console.error(`formatToTaipei error for string: ${utcString}`, e);
            return utcString;
        }
    }

    function formatForInput(utcString) {
        if (!utcString) return '';
        try {
            // ç¢ºä¿å­—ä¸²æ˜¯æ¨™æº– ISO æ ¼å¼ï¼Œä¸¦å¼·åˆ¶è¦–ç‚º UTC
            let isoString = utcString.replace(' ', 'T');
            if (!isoString.includes('Z') && !isoString.match(/[+\-]\d{2}:\d{2}$/)) {
                isoString += 'Z';
            }
            const date = new Date(isoString);
            if (isNaN(date)) throw new Error('Invalid date object created');

            // è½‰æ›ç‚ºæœ¬åœ°æ™‚é–“ä»¥æ­£ç¢ºé¡¯ç¤ºåœ¨ datetime-local è¼¸å…¥æ¡†ä¸­
            const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
            return localDate.toISOString().slice(0, 16);
        } catch (e) {
            console.error(`formatForInput error for string: ${utcString}`, e);
            return ''; // è¿”å›ç©ºå­—ä¸²ä»¥é¿å…éŒ¯èª¤ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é‡æ–°é¸æ“‡
        }
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();
            const select = document.getElementById('userSelect');
            if (data.users && data.users.length > 0) {
                select.innerHTML = '<option value="">è«‹é¸æ“‡ç”¨æˆ¶</option>';
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.line_user_id})`;
                    option.dataset.name = user.name;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">æ²’æœ‰å¯ç”¨çš„ç”¨æˆ¶</option>';
            }
        } catch (error) {
            console.error('è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', error);
        }
    }

    async function loadSchedules() {
        try {
            const response = await fetch('/api/admin/schedule/list');
            const data = await response.json();
            const listEl = document.getElementById('scheduleList');
            const countEl = document.getElementById('scheduleCount');
            countEl.textContent = data.count;
            if (data.schedules && data.schedules.length > 0) {
                listEl.innerHTML = '';
                data.schedules.forEach(schedule => {
                    const li = document.createElement('li'); // å»ºç«‹ li å…ƒç´ 
                    li.className = 'schedule-item'; // è¨­å®š class

                    // å»ºç«‹ schedule-info div
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'schedule-info';

                    // æ±ºå®šç‹€æ…‹çš„ class å’Œæ–‡å­—
                    const statusMap = {
                        'sent': { class: 'status-sent', text: 'å·²ç™¼é€' },
                        'failed': { class: 'status-failed', text: 'ç™¼é€å¤±æ•—' },
                        'pending': { class: 'status-pending', text: 'å¾…ç™¼é€' }
                    };
                    const statusInfo = statusMap[schedule.status] || statusMap['pending'];

                    // ä½¿ç”¨ innerHTML å¡«å…… infoDiv çš„å…§å®¹
                    infoDiv.innerHTML = `
                        <div class="schedule-user">${schedule.user_name || 'æœªçŸ¥ç”¨æˆ¶'}</div>
                        <div class="schedule-time">â° ${formatToTaipei(schedule.send_time)}</div>
                        <div class="schedule-message">${schedule.message}</div>
                        <span class="schedule-status ${statusInfo.class}">${statusInfo.text}</span>
                    `;

                    // å°‡ infoDiv åŠ å…¥ li
                    li.appendChild(infoDiv);
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'schedule-actions';

                    // å¦‚æœç‹€æ…‹æ˜¯ pendingï¼Œæ‰å»ºç«‹ä¸¦åŠ å…¥ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•
                    if (schedule.status === 'pending') {
                        const editBtn = document.createElement('button');
                        editBtn.className = 'action-btn edit-btn';
                        editBtn.textContent = 'ç·¨è¼¯';
                        editBtn.onclick = () => startEditing(schedule);
                        actionsDiv.appendChild(editBtn);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'action-btn delete-btn';
                        deleteBtn.textContent = 'åˆªé™¤';
                        deleteBtn.onclick = () => deleteSchedule(schedule.id);
                        actionsDiv.appendChild(deleteBtn);
                    }

                    // æœ€å¾Œå°‡å®Œæ•´çš„ li åŠ å…¥åˆ—è¡¨
                    li.appendChild(actionsDiv);
                    listEl.appendChild(li);
                });
            } else {
                listEl.innerHTML = '<li class="empty-state">å°šç„¡æ’ç¨‹</li>';
            }
        } catch (error) {
            console.error('è¼‰å…¥æ’ç¨‹å¤±æ•—:', error);
        }
    }

    let editModalInstance = null;

    function startEditing(schedule) {
        if (!editModalInstance) {
            editModalInstance = new bootstrap.Modal(document.getElementById('editScheduleModal'));
        }
        document.getElementById('editingUserName').textContent = schedule.user_name;
        document.getElementById('editSendTime').value = formatForInput(schedule.send_time);
        
        const saveBtn = document.getElementById('saveTimeChangeBtn');
        // ç§»é™¤èˆŠçš„ç›£è½å™¨ä»¥é˜²é‡è¤‡ç¶å®š
        saveBtn.replaceWith(saveBtn.cloneNode(true));
        document.getElementById('saveTimeChangeBtn').addEventListener('click', () => saveScheduleTime(schedule.id));

        editModalInstance.show();
    }

    async function saveScheduleTime(scheduleId) {
        const newTime = document.getElementById('editSendTime').value;
        if (!newTime) {
            showMessage('è«‹é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„æ™‚é–“', 'error');
            return;
        }
        try {
            const response = await fetch(`/api/admin/schedule/${scheduleId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ send_time: newTime })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'æ›´æ–°å¤±æ•—');
            showMessage('âœ… æ’ç¨‹æ™‚é–“å·²æ›´æ–°', 'success');
            
            // è§£æ±º accessibility è­¦å‘Šï¼šåœ¨éš±è— modal å‰ï¼Œå°‡ç„¦é»ç§»å‡º
            document.body.focus();
            editModalInstance.hide();
            loadSchedules();
        } catch (error) { showMessage(`âŒ æ›´æ–°å¤±æ•—: ${error.message}`, 'error'); }
    }

    async function addSchedule() {
        const select = document.getElementById('userSelect');
        const userId = select.value;
        const userName = select.options[select.selectedIndex]?.dataset?.name || 'æœªçŸ¥';
        const sendTime = document.getElementById('sendTime').value;
        const message = document.getElementById('messageText').value;
        if (!userId) {
            showMessage('è«‹é¸æ“‡ç”¨æˆ¶', 'error');
            return;
        }
        if (!sendTime) {
            showMessage('è«‹é¸æ“‡ç™¼é€æ™‚é–“', 'error');
            return;
        }
        if (!message.trim()) {
            showMessage('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹', 'error');
            return;
        }
        try {
            const response = await fetch('/api/admin/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    user_name: userName,
                    send_time: sendTime, // ç›´æ¥å‚³é datetime-local çš„åŸå§‹å€¼
                    message: message
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showMessage('æ’ç¨‹å·²æ–°å¢æˆåŠŸï¼', 'success');
                document.getElementById('sendTime').value = '';
                document.getElementById('messageText').value = '';
                loadSchedules();
            } else {
                showMessage(data.message || 'æ–°å¢å¤±æ•—', 'error');
            }
        } catch (error) {
            console.error('æ–°å¢æ’ç¨‹å¤±æ•—:', error);
            showMessage('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
    }

    async function deleteSchedule(scheduleId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ’ç¨‹å—ï¼Ÿ')) {
            return;
        }
        try {
            const response = await fetch(`/api/admin/schedule/${scheduleId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            if (data.status === 'success') {
                showMessage('æ’ç¨‹å·²åˆªé™¤', 'success');
                loadSchedules();
            } else {
                showMessage('åˆªé™¤å¤±æ•—', 'error');
            }
        } catch (error) {
            console.error('åˆªé™¤æ’ç¨‹å¤±æ•—:', error);
            showMessage('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
    }

    loadUsers();
    loadSchedules();
    setInterval(loadSchedules, 10000);
</script>
{% endblock %}