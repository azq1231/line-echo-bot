{% extends "base.html" %}
{% block title %}時段設定{% endblock %}
{% block header %}⚙️ 可預約時段設定{% endblock %}

{% block content %}
<style>
    .weekday-group {
        margin-bottom: 30px;
    }
    .weekday-header {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
    }
    .slot-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        background-color: #f8f9fa;
        margin-bottom: 8px;
        gap: 15px;
    }
    .slot-time {
        font-weight: 500;
        min-width: 120px;
    }
    .slot-note {
        color: #6c757d;
        flex-grow: 1;
    }
    .slot-status {
        font-weight: bold;
    }
    .status-active { color: #28a745; }
    .status-inactive { color: #dc3545; }
    .btn-action {
        padding: 4px 8px;
        font-size: 12px;
    }
    #message-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        width: 90%;
        max-width: 500px;
    }
</style>

<div class="container my-4">
    <div id="message-container"></div>

    <div class="d-flex justify-content-end align-items-center mb-4 gap-2" id="page-actions">
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#copyModal">
            <i class="bi bi-files"></i> 複製週二設定
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#slotModal">
            <i class="bi bi-plus-circle"></i> 新增時段
        </button>
    </div>

    {% set weekday_names = {1: '週二', 2: '週三', 3: '週四', 4: '週五', 5: '週六'} %}
    {% for weekday, slots in slots_by_weekday.items() %}
    <div class="weekday-group">
        <div class="weekday-header">{{ weekday_names[weekday] }}</div>
        {% if slots %}
            {% for slot in slots %}
            <div class="slot-item">
                <div class="slot-time">{{ slot.start_time }} - {{ slot.end_time }}</div>
                <div class="slot-note">{{ slot.note or '' }}</div>
                <div class="slot-status {{ 'status-active' if slot.active else 'status-inactive' }}">
                    {{ '啟用' if slot.active else '停用' }}
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary btn-action" data-bs-toggle="modal" data-bs-target="#slotModal" data-action="edit" data-slot='{{ slot|tojson }}'>✏️ 編輯</button>
                    <button class="btn btn-sm btn-outline-danger btn-action" data-action="delete" data-slot-id="{{ slot.id }}">🗑️ 刪除</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-muted">本日無設定時段</div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Modal -->
<div class="modal fade" id="slotModal" tabindex="-1" aria-labelledby="slotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="slotModalLabel">新增/編輯時段</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="slotForm">
                    <input type="hidden" id="slotId">
                    <div class="mb-3">
                        <label for="weekday" class="form-label">星期</label>
                        <select class="form-select" id="weekday" required>
                            <option value="1">週二</option>
                            <option value="2">週三</option>
                            <option value="3">週四</option>
                            <option value="4">週五</option>
                            <option value="5">週六</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="startTime" class="form-label">開始時間</label>
                            <div class="input-group">
                                <select class="form-select" id="startPeriod"><option value="am">上午</option><option value="pm">下午</option></select>
                                <select class="form-select" id="startHour"></select>
                                <select class="form-select" id="startMinute">
                                    <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <label for="endTime" class="form-label">結束時間</label>
                            <div class="input-group">
                                <select class="form-select" id="endPeriod"><option value="am">上午</option><option value="pm">下午</option></select>
                                <select class="form-select" id="endHour"></select>
                                <select class="form-select" id="endMinute">
                                    <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="note" class="form-label">備註 (選填)</label>
                        <input type="text" class="form-control" id="note" placeholder="例如：午休">
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="active" checked>
                        <label class="form-check-label" for="active">啟用此時段</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-primary" onclick="saveSlot()">儲存</button>
            </div>
        </div>
    </div>
</div>

<!-- Copy Modal -->
<div class="modal fade" id="copyModal" tabindex="-1" aria-labelledby="copyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="copyModalLabel">批次複製時段設定</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="sourceWeekday" class="form-label">從哪個星期複製？</label>
                    <select class="form-select" id="sourceWeekday">
                        <option value="1">週二</option><option value="2">週三</option><option value="3">週四</option><option value="4">週五</option><option value="5">週六</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">複製到哪些星期？ (將會覆蓋)</label>
                    <div id="targetWeekdays">
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="target-1"><label class="form-check-label" for="target-1">週二</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="2" id="target-2"><label class="form-check-label" for="target-2">週三</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="3" id="target-3"><label class="form-check-label" for="target-3">週四</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="4" id="target-4"><label class="form-check-label" for="target-4">週五</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="5" id="target-5"><label class="form-check-label" for="target-5">週六</label></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="executeCopy()">確認複製</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type = 'info') {
        const container = document.getElementById('message-container');
        const alertEl = document.createElement('div');
        alertEl.className = `alert alert-${type} alert-dismissible fade show`;
        alertEl.role = 'alert';
        alertEl.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        container.appendChild(alertEl);
        setTimeout(() => {
            const alertInstance = bootstrap.Alert.getOrCreateInstance(alertEl);
            if (alertInstance) alertInstance.close();
        }, 3000);
    }

    function prepareAddModal() {
        document.getElementById('slotForm').reset();
        document.getElementById('slotId').value = '';
        document.getElementById('slotModalLabel').textContent = '新增時段';
        document.getElementById('active').checked = true;
    }

    function prepareEditModal(slot) {
        document.getElementById('slotForm').reset();
        document.getElementById('slotId').value = slot.id;
        document.getElementById('weekday').value = slot.weekday;        
        document.getElementById('note').value = slot.note || '';
        document.getElementById('active').checked = slot.active;
        document.getElementById('slotModalLabel').textContent = '編輯時段';
        
        setTimeSelectors('start', slot.start_time);
        setTimeSelectors('end', slot.end_time);
    }

    function setTimeSelectors(prefix, timeStr) {
        const [hour, minute] = timeStr.split(':').map(Number);
        const period = hour < 12 ? 'am' : 'pm';
        const displayHour = period === 'am' ? hour : (hour === 12 ? 12 : hour - 12);

        document.getElementById(`${prefix}Period`).value = period;
        updateHourOptions(prefix, period); // 更新小時選項
        document.getElementById(`${prefix}Hour`).value = displayHour;
        document.getElementById(`${prefix}Minute`).value = String(minute).padStart(2, '0');
    }

    async function saveSlot() {
        const slotId = document.getElementById('slotId').value;
        const data = {
            weekday: document.getElementById('weekday').value,
            start_time: document.getElementById('startTime').value,
            note: document.getElementById('note').value,
            active: document.getElementById('active').checked,
        };

        if (data.start_time >= data.end_time) {
            showAlert('結束時間必須晚於開始時間', 'danger');
            return;
        }

        const url = slotId ? `/api/slots/${slotId}` : '/api/slots';
        const method = slotId ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('slotModal'));
                modal.hide();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert(result.message || '儲存失敗', 'danger');
            }
        } catch (error) {
            showAlert('網路錯誤', 'danger');
        }
    }

    async function deleteSlot(slotId) {
        if (!confirm('您確定要刪除這個時段設定嗎？')) return;

        try {
            const response = await fetch(`/api/slots/${slotId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert(result.message || '刪除失敗', 'danger');
            }
        } catch (error) {
            showAlert('網路錯誤', 'danger');
        }
    }

    async function executeCopy() {
        const sourceWeekday = document.getElementById('sourceWeekday').value;
        const targetWeekdays = Array.from(document.querySelectorAll('#targetWeekdays input:checked')).map(el => el.value);

        if (targetWeekdays.length === 0) {
            showAlert('請至少選擇一個目標星期', 'warning');
            return;
        }

        if (!confirm('確定要執行複製嗎？\n目標星期的現有設定將被覆蓋。')) return;

        try {
            const response = await fetch('/api/slots/copy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_weekday: sourceWeekday, target_weekdays: targetWeekdays })
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('copyModal'));
                modal.hide();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showAlert(result.message || '複製失敗', 'danger');
            }
        } catch (error) {
            showAlert('網路錯誤', 'danger');
        }
    }

    function updateHourOptions(prefix, period) {
        const hourSelect = document.getElementById(`${prefix}Hour`);
        hourSelect.innerHTML = '';
        const hours = (period === 'am') ? 
            [...Array(12).keys()] :  // 0-11
            [...Array(12).keys()].map(i => i + 12); // 12-23

        hours.forEach(h => {
            const option = document.createElement('option');
            const displayHour = (period === 'am') ? h : (h === 12 ? 12 : h - 12);
            option.value = displayHour;
            option.textContent = String(displayHour).padStart(2, '0');
            hourSelect.appendChild(option);
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // 初始化時間選擇器
        ['start', 'end'].forEach(prefix => {
            const periodSelect = document.getElementById(`${prefix}Period`);
            updateHourOptions(prefix, periodSelect.value);
            periodSelect.addEventListener('change', () => updateHourOptions(prefix, periodSelect.value));
        });

        // 事件委派
        const container = document.querySelector('.container');
        container.addEventListener('click', function(event) {
            const target = event.target;
            if (target.matches('.btn-action[data-action="edit"]')) {
                const slotData = JSON.parse(target.dataset.slot);
                prepareEditModal(slotData);
            } else if (target.matches('.btn-action[data-action="delete"]')) {
                const slotId = target.dataset.slotId;
                deleteSlot(slotId);
            }
        });

        document.getElementById('page-actions').addEventListener('click', function(event) {
            const target = event.target.closest('button');
            if (!target) return;
            if (target.dataset.bsTarget === '#slotModal') {
                prepareAddModal();
            }
        });
    });
</script>
{% endblock %}