{% extends "base.html" %}
{% block title %}æ™‚æ®µè¨­å®š{% endblock %}
{% block header %}âš™ï¸ å¯é ç´„æ™‚æ®µè¨­å®š{% endblock %}

{% block content %}
<style>
    .weekday-group {
        margin-bottom: 30px;
    }
    .weekday-header {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
    }
    .slot-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        background-color: #f8f9fa;
        margin-bottom: 8px;
        gap: 15px;
    }
    .slot-time {
        font-weight: 500;
        min-width: 120px;
    }
    .slot-note {
        color: #6c757d;
        flex-grow: 1;
    }
    .slot-status {
        font-weight: bold;
    }
    .status-active { color: #28a745; }
    .status-inactive { color: #dc3545; }
    .btn-action {
        padding: 4px 8px;
        font-size: 12px;
    }
    #message-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        width: 90%;
        max-width: 500px;
    }
</style>

<div class="container my-4">
    <div id="message-container"></div>

    <div class="d-flex justify-content-end align-items-center mb-4 gap-2">
        <button class="btn btn-outline-secondary" onclick="copyTuesdaySlots()">
            <i class="bi bi-files"></i> è¤‡è£½é€±äºŒè¨­å®š
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#slotModal" onclick="prepareAddModal()">
            <i class="bi bi-plus-circle"></i> æ–°å¢æ™‚æ®µ
        </button>
    </div>

    {% set weekday_names = {1: 'é€±äºŒ', 2: 'é€±ä¸‰', 3: 'é€±å››', 4: 'é€±äº”', 5: 'é€±å…­'} %}
    {% for weekday, slots in slots_by_weekday.items() %}
    <div class="weekday-group">
        <div class="weekday-header">{{ weekday_names[weekday] }}</div>
        {% if slots %}
            {% for slot in slots %}
            <div class="slot-item">
                <div class="slot-time">{{ slot.start_time }} - {{ slot.end_time }}</div>
                <div class="slot-note">{{ slot.note or '' }}</div>
                <div class="slot-status {{ 'status-active' if slot.active else 'status-inactive' }}">
                    {{ 'å•Ÿç”¨' if slot.active else 'åœç”¨' }}
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary btn-action" data-bs-toggle="modal" data-bs-target="#slotModal" data-action="edit" data-slot='{{ slot|tojson }}'>âœï¸ ç·¨è¼¯</button>
                    <button class="btn btn-sm btn-outline-danger btn-action" data-action="delete" data-slot-id="{{ slot.id }}">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-muted">æœ¬æ—¥ç„¡è¨­å®šæ™‚æ®µ</div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Modal -->
<div class="modal fade" id="slotModal" tabindex="-1" aria-labelledby="slotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="slotModalLabel">æ–°å¢/ç·¨è¼¯æ™‚æ®µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="slotForm">
                    <input type="hidden" id="slotId">
                    <div class="mb-3">
                        <label for="weekday" class="form-label">æ˜ŸæœŸ</label>
                        <select class="form-select" id="weekday" required>
                            <option value="1">é€±äºŒ</option>
                            <option value="2">é€±ä¸‰</option>
                            <option value="3">é€±å››</option>
                            <option value="4">é€±äº”</option>
                            <option value="5">é€±å…­</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="startTime" class="form-label">é–‹å§‹æ™‚é–“</label>
                            <input type="time" class="form-control" id="startTime" step="900" list="time-options" required>
                        </div>
                        <div class="col">
                            <label for="endTime" class="form-label">çµæŸæ™‚é–“</label>
                            <input type="time" class="form-control" id="endTime" step="900" list="time-options" required>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="note" class="form-label">å‚™è¨» (é¸å¡«)</label>
                        <input type="text" class="form-control" id="note" placeholder="ä¾‹å¦‚ï¼šåˆä¼‘">
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="active" checked>
                        <label class="form-check-label" for="active">å•Ÿç”¨æ­¤æ™‚æ®µ</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                <button type="button" class="btn btn-primary" onclick="saveSlot()">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<datalist id="time-options">
    {% for h in range(24) %}
        {% for m in [0, 15, 30, 45] %}
            <option value="{{ '%02d:%02d'|format(h, m) }}">
        {% endfor %}
    {% endfor %}
</datalist>

{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type = 'info') {
        const container = document.getElementById('message-container');
        const alertEl = document.createElement('div');
        alertEl.className = `alert alert-${type} alert-dismissible fade show`;
        alertEl.role = 'alert';
        alertEl.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        container.appendChild(alertEl);
        setTimeout(() => {
            const alertInstance = bootstrap.Alert.getOrCreateInstance(alertEl);
            if (alertInstance) alertInstance.close();
        }, 3000);
    }

    function prepareAddModal() {
        document.getElementById('slotForm').reset();
        document.getElementById('slotId').value = '';
        document.getElementById('slotModalLabel').textContent = 'æ–°å¢æ™‚æ®µ';
        document.getElementById('active').checked = true;
    }

    function prepareEditModal(slot) {
        document.getElementById('slotForm').reset();
        document.getElementById('slotId').value = slot.id;
        document.getElementById('weekday').value = slot.weekday;
        document.getElementById('startTime').value = slot.start_time;
        document.getElementById('endTime').value = slot.end_time;
        document.getElementById('note').value = slot.note || '';
        document.getElementById('active').checked = slot.active;
        document.getElementById('slotModalLabel').textContent = 'ç·¨è¼¯æ™‚æ®µ';
    }

    async function saveSlot() {
        const slotId = document.getElementById('slotId').value;
        const data = {
            weekday: document.getElementById('weekday').value,
            start_time: document.getElementById('startTime').value,
            end_time: document.getElementById('endTime').value,
            note: document.getElementById('note').value,
            active: document.getElementById('active').checked,
        };

        if (data.start_time >= data.end_time) {
            showAlert('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“', 'danger');
            return;
        }

        const url = slotId ? `/api/slots/${slotId}` : '/api/slots';
        const method = slotId ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('slotModal'));
                modal.hide();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert(result.message || 'å„²å­˜å¤±æ•—', 'danger');
            }
        } catch (error) {
            showAlert('ç¶²è·¯éŒ¯èª¤', 'danger');
        }
    }

    async function deleteSlot(slotId) {
        if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹æ™‚æ®µè¨­å®šå—ï¼Ÿ')) return;

        try {
            const response = await fetch(`/api/slots/${slotId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert(result.message || 'åˆªé™¤å¤±æ•—', 'danger');
            }
        } catch (error) {
            showAlert('ç¶²è·¯éŒ¯èª¤', 'danger');
        }
    }

    async function copyTuesdaySlots() {
        if (!confirm('æ‚¨ç¢ºå®šè¦å°‡ã€Œé€±äºŒã€çš„æ™‚æ®µè¨­å®šè¤‡è£½åˆ°ã€Œé€±ä¸‰è‡³é€±å…­ã€å—ï¼Ÿ\n\né€™å°‡æœƒè¦†è“‹æ‰é€±ä¸‰è‡³é€±å…­ç¾æœ‰çš„æ‰€æœ‰è¨­å®šã€‚')) return;

        try {
            const response = await fetch('/api/slots/copy_tuesday', {
                method: 'POST'
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showAlert(result.message || 'è¤‡è£½å¤±æ•—', 'danger');
            }
        } catch (error) {
            showAlert('ç¶²è·¯éŒ¯èª¤', 'danger');
        }
    }


    document.addEventListener('DOMContentLoaded', function () {
        // 1. ä½¿ç”¨äº‹ä»¶å§”æ´¾è™•ç†æ‰€æœ‰æŒ‰éˆ•é»æ“Š
        const container = document.querySelector('.container');
        container.addEventListener('click', function(event) {
            const target = event.target;
            if (target.matches('.btn-action[data-action="edit"]')) {
                const slotData = JSON.parse(target.dataset.slot);
                prepareEditModal(slotData);
            } else if (target.matches('.btn-action[data-action="delete"]')) {
                const slotId = target.dataset.slotId;
                deleteSlot(slotId);
            } else if (target.matches('button[onclick="copyTuesdaySlots()"]')) {
                copyTuesdaySlots();
            } else if (target.matches('button[onclick="prepareAddModal()"]')) {
                prepareAddModal();
            }
        });
    });
</script>
{% endblock %}