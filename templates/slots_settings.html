{% extends "base.html" %}
{% block title %}æ™‚æ®µè¨­å®š{% endblock %}
{% block header %}âš™ï¸ å¯é ç´„æ™‚æ®µè¨­å®š{% endblock %}

{% block content %}
<style>
    .weekday-group {
        margin-bottom: 30px;
    }

    .weekday-header {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
    }

    .slot-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        background-color: #f8f9fa;
        margin-bottom: 8px;
        gap: 15px;
    }

    .slot-time {
        font-weight: 500;
        min-width: 120px;
    }

    .slot-note {
        color: #6c757d;
        flex-grow: 1;
    }

    .slot-status {
        font-weight: bold;
    }

    .status-active {
        color: #28a745;
    }

    .status-inactive {
        color: #dc3545;
    }

    .btn-action {
        padding: 4px 8px;
        font-size: 12px;
    }

    #message-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        width: 90%;
        max-width: 500px;
    }
</style>

<div class="container my-4">
    <div id="message-container"></div>

    <div class="d-flex justify-content-end align-items-center mb-4 gap-2" id="page-actions">
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#copyModal">
            <i class="bi bi-files"></i> è¤‡è£½é€±äºŒè¨­å®š
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#slotModal">
            <i class="bi bi-plus-circle"></i> æ–°å¢æ™‚æ®µ
        </button>
    </div>

    {% set weekday_names = {1: 'é€±äºŒ', 2: 'é€±ä¸‰', 3: 'é€±å››', 4: 'é€±äº”', 5: 'é€±å…­'} %}
    {% for weekday, slots in slots_by_weekday.items() %}
    <div class="weekday-group">
        <div class="weekday-header">{{ weekday_names[weekday] }}</div>
        {% if slots %}
        {% for slot in slots %}
        <div class="slot-item">
            <div class="slot-time">{{ slot.start_time }} - {{ slot.end_time }}</div>
            <div class="slot-note">{{ slot.note or '' }}</div>
            <span class="badge bg-{{ 'info' if slot.get('type') == 'massage' else 'primary' }}">
                {{ 'æ¨æ‹¿' if slot.get('type') == 'massage' else 'çœ‹è¨º' }}
            </span>
            <div class="slot-status {{ 'status-active' if slot.active else 'status-inactive' }}">
                {{ 'å•Ÿç”¨' if slot.active else 'åœç”¨' }}
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary btn-action" data-bs-toggle="modal"
                    data-bs-target="#slotModal" data-action="edit" data-slot='{{ slot|tojson }}'>âœï¸ ç·¨è¼¯</button>
                <button class="btn btn-sm btn-outline-danger btn-action" data-action="delete"
                    data-slot-id="{{ slot.id }}">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-muted">æœ¬æ—¥ç„¡è¨­å®šæ™‚æ®µ</div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Modal -->
<div class="modal fade" id="slotModal" tabindex="-1" aria-labelledby="slotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="slotModalLabel">æ–°å¢/ç·¨è¼¯æ™‚æ®µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="slotForm">
                    <input type="hidden" id="slotId">
                    <div class="mb-3">
                        <label for="typeSelect" class="form-label">é¡å‹</label>
                        <select class="form-select" id="typeSelect" required>
                            <option value="consultation">çœ‹è¨º</option>
                            <option value="massage">æ¨æ‹¿</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="weekday" class="form-label">æ˜ŸæœŸ</label>
                        <select class="form-select" id="weekday" required>
                            <option value="1">é€±äºŒ</option>
                            <option value="2">é€±ä¸‰</option>
                            <option value="3">é€±å››</option>
                            <option value="4">é€±äº”</option>
                            <option value="5">é€±å…­</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="startTime" class="form-label">é–‹å§‹æ™‚é–“</label>
                            <div class="input-group">
                                <select class="form-select" id="startPeriod">
                                    <option value="am">ä¸Šåˆ</option>
                                    <option value="pm">ä¸‹åˆ</option>
                                </select>
                                <select class="form-select" id="startHour"></select>
                                <select class="form-select" id="startMinute">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <label for="endTime" class="form-label">çµæŸæ™‚é–“</label>
                            <div class="input-group">
                                <select class="form-select" id="endPeriod">
                                    <option value="am">ä¸Šåˆ</option>
                                    <option value="pm">ä¸‹åˆ</option>
                                </select>
                                <select class="form-select" id="endHour"></select>
                                <select class="form-select" id="endMinute">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="note" class="form-label">å‚™è¨» (é¸å¡«)</label>
                        <input type="text" class="form-control" id="note" placeholder="ä¾‹å¦‚ï¼šåˆä¼‘">
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="active" checked>
                        <label class="form-check-label" for="active">å•Ÿç”¨æ­¤æ™‚æ®µ</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                <button type="button" class="btn btn-primary" onclick="saveSlot()">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- Copy Modal -->
<div class="modal fade" id="copyModal" tabindex="-1" aria-labelledby="copyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="copyModalLabel">æ‰¹æ¬¡è¤‡è£½æ™‚æ®µè¨­å®š</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="sourceWeekday" class="form-label">å¾å“ªå€‹æ˜ŸæœŸè¤‡è£½ï¼Ÿ</label>
                    <select class="form-select" id="sourceWeekday">
                        <option value="1">é€±äºŒ</option>
                        <option value="2">é€±ä¸‰</option>
                        <option value="3">é€±å››</option>
                        <option value="4">é€±äº”</option>
                        <option value="5">é€±å…­</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">è¤‡è£½åˆ°å“ªäº›æ˜ŸæœŸï¼Ÿ (å°‡æœƒè¦†è“‹)</label>
                    <div id="targetWeekdays">
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="1"
                                id="target-1"><label class="form-check-label" for="target-1">é€±äºŒ</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="2"
                                id="target-2"><label class="form-check-label" for="target-2">é€±ä¸‰</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="3"
                                id="target-3"><label class="form-check-label" for="target-3">é€±å››</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="4"
                                id="target-4"><label class="form-check-label" for="target-4">é€±äº”</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="5"
                                id="target-5"><label class="form-check-label" for="target-5">é€±å…­</label></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="executeCopy()">ç¢ºèªè¤‡è£½</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type = 'info') {
        const container = document.getElementById('message-container');
        const alertEl = document.createElement('div');
        alertEl.className = `alert alert-${type} alert-dismissible fade show`;
        alertEl.role = 'alert';
        alertEl.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        container.appendChild(alertEl);
        setTimeout(() => {
            const alertInstance = bootstrap.Alert.getOrCreateInstance(alertEl);
            if (alertInstance) alertInstance.close();
        }, 3000);
    }

    function prepareAddModal() {
        document.getElementById('slotForm').reset();
        document.getElementById('slotId').value = '';
        document.getElementById('typeSelect').value = 'consultation';
        document.getElementById('slotModalLabel').textContent = 'æ–°å¢æ™‚æ®µ';
        document.getElementById('active').checked = true;
    }

    function prepareEditModal(slot) {
        document.getElementById('slotForm').reset();
        document.getElementById('slotId').value = slot.id;
        document.getElementById('typeSelect').value = slot.type || 'consultation';
        document.getElementById('weekday').value = slot.weekday;
        document.getElementById('note').value = slot.note || '';
        document.getElementById('active').checked = slot.active;
        document.getElementById('slotModalLabel').textContent = 'ç·¨è¼¯æ™‚æ®µ';

        setTimeSelectors('start', slot.start_time);
        setTimeSelectors('end', slot.end_time);
    }

    function getCombinedTime(prefix) {
        const period = document.getElementById(`${prefix}Period`).value;
        const hour = parseInt(document.getElementById(`${prefix}Hour`).value, 10);
        const minute = document.getElementById(`${prefix}Minute`).value;

        let h24 = hour;
        if (period === 'pm' && hour !== 12) {
            h24 = hour + 12;
        } else if (period === 'am' && hour === 12) { // 12 AM is 00:xx
            h24 = 0;
        }

        return `${String(h24).padStart(2, '0')}:${minute}`;
    }

    function setTimeSelectors(prefix, timeStr) {
        const [hour, minute] = timeStr.split(':').map(Number);
        const period = hour < 12 ? 'am' : 'pm';
        let displayHour = hour;
        if (period === 'pm' && hour > 12) displayHour = hour - 12;
        if (period === 'am' && hour === 0) displayHour = 12; // 00:xx is 12 AM

        document.getElementById(`${prefix}Period`).value = period;
        updateHourOptions(prefix, period);
        document.getElementById(`${prefix}Hour`).value = displayHour;
        document.getElementById(`${prefix}Minute`).value = String(minute).padStart(2, '0');
    }

    async function saveSlot() {
        const slotId = document.getElementById('slotId').value;
        const data = {
            weekday: document.getElementById('weekday').value,
            start_time: getCombinedTime('start'),
            end_time: getCombinedTime('end'),
            note: document.getElementById('note').value,
            active: document.getElementById('active').checked,
            type: document.getElementById('typeSelect').value
        };

        if (data.start_time >= data.end_time) {
            showAlert('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“', 'danger');
            return;
        }

        const url = slotId ? `/api/admin/slots/${slotId}` : '/api/admin/slots';
        const method = slotId ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('slotModal'));
                modal.hide();
                setTimeout(() => window.location.reload(), 800);
            } else {
                showAlert(result.message || 'å„²å­˜å¤±æ•—', 'danger');
            }
        } catch (error) {
            showAlert('ç¶²è·¯éŒ¯èª¤', 'danger');
        }
    }

    async function deleteSlot(slotId) {
        if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹æ™‚æ®µè¨­å®šå—ï¼Ÿ')) return;

        try {
            const response = await fetch(`/api/admin/slots/${slotId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                setTimeout(() => window.location.reload(), 800);
            } else {
                showAlert(result.message || 'åˆªé™¤å¤±æ•—', 'danger');
            }
        } catch (error) {
            showAlert('ç¶²è·¯éŒ¯èª¤', 'danger');
        }
    }

    async function executeCopy() {
        const sourceWeekday = document.getElementById('sourceWeekday').value;
        const targetWeekdays = Array.from(document.querySelectorAll('#targetWeekdays input:checked')).map(el => el.value);

        if (targetWeekdays.length === 0) {
            showAlert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç›®æ¨™æ˜ŸæœŸ', 'warning');
            return;
        }

        if (!confirm('ç¢ºå®šè¦åŸ·è¡Œè¤‡è£½å—ï¼Ÿ\nç›®æ¨™æ˜ŸæœŸçš„ç¾æœ‰è¨­å®šå°‡è¢«è¦†è“‹ã€‚')) return;

        try {
            const response = await fetch('/api/admin/slots/copy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_weekday: sourceWeekday, target_weekdays: targetWeekdays })
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('copyModal'));
                modal.hide();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert(result.message || 'è¤‡è£½å¤±æ•—', 'danger');
            }
        } catch (error) {
            showAlert('ç¶²è·¯éŒ¯èª¤', 'danger');
        }
    }

    function updateHourOptions(prefix, period) {
        const hourSelect = document.getElementById(`${prefix}Hour`);
        hourSelect.innerHTML = '';
        const hours = [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

        hours.forEach(h => {
            const option = document.createElement('option');
            option.value = h;
            option.textContent = String(h).padStart(2, '0');
            hourSelect.appendChild(option);
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŒ–æ™‚é–“é¸æ“‡å™¨
        ['start', 'end'].forEach(prefix => {
            const periodSelect = document.getElementById(`${prefix}Period`);
            updateHourOptions(prefix, periodSelect.value);
            periodSelect.addEventListener('change', () => updateHourOptions(prefix, periodSelect.value));
        });

        // äº‹ä»¶å§”æ´¾
        const container = document.querySelector('.container');
        container.addEventListener('click', function (event) {
            const target = event.target;
            if (target.matches('.btn-action[data-action="edit"]')) {
                const slotData = JSON.parse(target.dataset.slot);
                prepareEditModal(slotData);
            } else if (target.matches('.btn-action[data-action="delete"]')) {
                const slotId = target.dataset.slotId;
                deleteSlot(slotId);
            }
        });

        document.getElementById('page-actions').addEventListener('click', function (event) {
            const target = event.target.closest('button');
            if (!target) return;
            if (target.dataset.bsTarget === '#slotModal') {
                prepareAddModal();
            }
        });
    });
</script>
{% endblock %}